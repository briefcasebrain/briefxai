<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BriefX - Unified Analysis Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        /* Navigation Bar */
        .navbar {
            background: var(--white);
            padding: 0.75rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            color: var(--primary);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Main Container */
        .main-container {
            margin-top: 60px;
            padding: 2rem;
            min-height: calc(100vh - 60px);
        }

        /* View Sections */
        .view-section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Upload View */
        .upload-container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .upload-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .upload-header h1 {
            font-size: 2rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .upload-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .upload-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .upload-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .upload-card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .upload-card p {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Analysis View */
        .analysis-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 1.5rem;
            height: calc(100vh - 100px);
        }

        .sidebar {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .main-content {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-top: 0.25rem;
        }

        /* Visualization Container */
        .viz-container {
            background: var(--light);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            min-height: 400px;
        }

        .viz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .viz-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .viz-controls {
            display: flex;
            gap: 0.5rem;
        }

        .viz-control {
            padding: 0.25rem 0.75rem;
            background: var(--white);
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .viz-control:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .viz-control.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        /* Cluster List */
        .cluster-list {
            margin-top: 1rem;
        }

        .cluster-item {
            background: var(--white);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }

        .cluster-item:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .cluster-item.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .cluster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .cluster-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .cluster-count {
            background: var(--light);
            padding: 0.15rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .cluster-item.active .cluster-count {
            background: rgba(255,255,255,0.2);
            color: var(--white);
        }

        .cluster-description {
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.4;
        }

        .cluster-item.active .cluster-description {
            color: rgba(255,255,255,0.9);
        }

        /* Progress Indicator */
        .progress-container {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            display: none;
            z-index: 900;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            background: var(--light);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        /* File Drop Zone */
        .drop-zone {
            border: 2px dashed var(--gray);
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--light);
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .drop-zone.active {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.1);
        }

        .drop-zone-icon {
            font-size: 3rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .drop-zone-text {
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .drop-zone-hint {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .analysis-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0.75rem 1rem;
            }
            
            .nav-tabs {
                display: none;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .upload-options {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background: var(--dark);
            color: var(--white);
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <span>üéØ</span>
            <span>BriefX</span>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-view="upload">Upload</button>
            <button class="nav-tab" data-view="analysis">Analysis</button>
            <button class="nav-tab" data-view="patterns">Patterns</button>
            <button class="nav-tab" data-view="insights">Insights</button>
            <button class="nav-tab" data-view="settings">Settings</button>
        </div>
        <div class="nav-actions">
            <button class="btn btn-secondary" onclick="showHelp()">Help</button>
            <button class="btn btn-primary" onclick="newProject()">New Project</button>
        </div>
    </nav>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-text" id="progressText">Processing...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Upload View -->
        <div class="view-section active" id="uploadView">
            <div class="upload-container">
                <div class="upload-header">
                    <h1>Start Your Analysis</h1>
                    <p>Choose how you'd like to import your conversation data</p>
                </div>
                
                <div class="upload-options">
                    <div class="upload-card" onclick="showFileUpload()">
                        <div class="upload-card-icon">üìÅ</div>
                        <h3>Upload Files</h3>
                        <p>JSON, CSV, Parquet, PDF, TXT</p>
                    </div>
                    
                    <div class="upload-card" onclick="useExampleData()">
                        <div class="upload-card-icon">üé≤</div>
                        <h3>Example Data</h3>
                        <p>Try with sample conversations</p>
                    </div>
                    
                    <div class="upload-card" onclick="showPasteDialog()">
                        <div class="upload-card-icon">üìã</div>
                        <h3>Paste Data</h3>
                        <p>Paste JSON or text directly</p>
                    </div>
                </div>

                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                    <h2 style="font-size: 1.3rem; margin-bottom: 1rem;">Recent Projects</h2>
                    <div id="recentProjects" style="display: grid; gap: 1rem;">
                        <!-- Recent projects will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis View -->
        <div class="view-section" id="analysisView">
            <div class="analysis-container">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <h3 style="margin-bottom: 1rem;">Clusters</h3>
                    <div class="cluster-list" id="clusterList">
                        <!-- Clusters will be loaded here -->
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="main-content">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Conversations</div>
                            <div class="metric-value" id="totalConversations">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Clusters Found</div>
                            <div class="metric-value" id="totalClusters">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Similarity</div>
                            <div class="metric-value" id="avgSimilarity">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Processing Time</div>
                            <div class="metric-value" id="processingTime">0s</div>
                        </div>
                    </div>

                    <div class="viz-container">
                        <div class="viz-header">
                            <h3 class="viz-title">Cluster Visualization</h3>
                            <div class="viz-controls">
                                <button class="viz-control active" onclick="showViz('scatter')">Scatter</button>
                                <button class="viz-control" onclick="showViz('hierarchy')">Hierarchy</button>
                                <button class="viz-control" onclick="showViz('timeline')">Timeline</button>
                                <button class="viz-control" onclick="showViz('heatmap')">Heatmap</button>
                            </div>
                        </div>
                        <div id="vizContainer" style="min-height: 400px;">
                            <!-- Visualization will be rendered here -->
                        </div>
                    </div>
                </main>

                <!-- Right Panel -->
                <aside class="sidebar">
                    <h3 style="margin-bottom: 1rem;">Details</h3>
                    <div id="detailsPanel">
                        <p style="color: var(--gray); text-align: center; padding: 2rem;">
                            Select a cluster to view details
                        </p>
                    </div>
                </aside>
            </div>
        </div>

        <!-- Patterns View -->
        <div class="view-section" id="patternsView">
            <div class="upload-container">
                <h2>Pattern Discovery</h2>
                <p>Analyzing recurring themes and patterns in your data...</p>
                <div id="patternsContent" style="margin-top: 2rem;">
                    <!-- Patterns will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Insights View -->
        <div class="view-section" id="insightsView">
            <div class="upload-container">
                <h2>Key Insights</h2>
                <p>Actionable insights derived from your conversation analysis</p>
                <div id="insightsContent" style="margin-top: 2rem;">
                    <!-- Insights will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div class="view-section" id="settingsView">
            <div class="upload-container">
                <h2>Settings</h2>
                <div style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Analysis Configuration</h3>
                    <div style="display: grid; gap: 1rem;">
                        <label>
                            <span style="display: block; margin-bottom: 0.5rem;">Provider</span>
                            <select id="providerSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                <option value="openai">OpenAI</option>
                                <option value="ollama">Ollama (Local)</option>
                                <option value="vllm">vLLM</option>
                            </select>
                        </label>
                        <label>
                            <span style="display: block; margin-bottom: 0.5rem;">Model</span>
                            <input type="text" id="modelInput" value="gpt-4o-mini" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                        </label>
                        <label>
                            <span style="display: block; margin-bottom: 0.5rem;">Batch Size</span>
                            <input type="number" id="batchSizeInput" value="100" min="1" max="1000" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                        </label>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 1.5rem;" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div class="modal" id="fileUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Upload Files</h2>
                <button class="modal-close" onclick="closeModal('fileUploadModal')">√ó</button>
            </div>
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">üì§</div>
                <div class="drop-zone-text">Drop files here or click to browse</div>
                <div class="drop-zone-hint">Supports JSON, CSV, Parquet, PDF, TXT files</div>
                <input type="file" id="fileInput" multiple accept=".json,.csv,.parquet,.pdf,.txt" style="display: none;">
            </div>
            <div id="fileList" style="margin-top: 1rem;"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="processFiles()">Process Files</button>
        </div>
    </div>

    <!-- Paste Data Modal -->
    <div class="modal" id="pasteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Paste Data</h2>
                <button class="modal-close" onclick="closeModal('pasteModal')">√ó</button>
            </div>
            <textarea id="pasteInput" style="width: 100%; min-height: 300px; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-family: monospace;" placeholder="Paste your JSON data here..."></textarea>
            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="processPastedData()">Process Data</button>
        </div>
    </div>

    <script>
        // State Management
        let currentView = 'upload';
        let currentData = null;
        let currentClusters = [];
        let selectedCluster = null;
        let processingStartTime = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadRecentProjects();
            // Initialize with example data for immediate visualization
            initializeWithExampleData();
        });

        // Initialize with example data
        function initializeWithExampleData() {
            // Set example data immediately for visualizations
            currentData = generateExampleData();
            // Don't switch views or start analysis, just have data ready
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchView(e.target.dataset.view);
                });
            });

            // File drop zone
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('active');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // View Management
        function switchView(viewName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === viewName);
            });

            // Update view sections
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewName + 'View').classList.add('active');

            currentView = viewName;

            // Load view-specific data
            if (viewName === 'analysis' && currentData) {
                renderAnalysis();
            } else if (viewName === 'patterns' && currentData) {
                renderPatterns();
            } else if (viewName === 'insights' && currentData) {
                renderInsights();
            }
        }

        // File Handling
        function showFileUpload() {
            document.getElementById('fileUploadModal').classList.add('active');
        }

        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            Array.from(files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'padding: 0.5rem; background: var(--light); border-radius: 0.25rem; margin-bottom: 0.5rem;';
                fileItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${file.name}</span>
                        <span style="color: var(--gray); font-size: 0.85rem;">${(file.size / 1024).toFixed(1)} KB</span>
                    </div>
                `;
                fileList.appendChild(fileItem);
            });
        }

        async function processFiles() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) return;

            closeModal('fileUploadModal');
            showProgress('Processing files...');

            // Simulate file processing
            processingStartTime = Date.now();
            
            // Read and process files
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            try {
                // Step 1: Upload files
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (uploadResponse.ok) {
                    const uploadData = await uploadResponse.json();
                    
                    // Step 2: Process conversations to get clusters
                    if (uploadData.data && uploadData.data.conversations) {
                        showProgress('Processing conversations...');
                        
                        const processResponse = await fetch('/api/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                conversations: uploadData.data.conversations
                            })
                        });
                        
                        if (processResponse.ok) {
                            const processedData = await processResponse.json();
                            if (processedData.success && processedData.data) {
                                currentData = processedData.data;
                                await startAnalysis(processedData.data);
                            } else {
                                // Fallback if processing fails
                                await useExampleData();
                            }
                        } else {
                            // Fallback if processing fails
                            await useExampleData();
                        }
                    } else {
                        // No conversations in upload response
                        await useExampleData();
                    }
                } else {
                    // Fallback to example data for demo
                    await useExampleData();
                }
            } catch (error) {
                console.error('Error processing files:', error);
                // Fallback to example data for demo
                await useExampleData();
            }
        }

        // Example Data
        async function useExampleData() {
            showProgress('Loading example data...');
            processingStartTime = Date.now();

            try {
                const response = await fetch('/api/example');
                if (response.ok) {
                    const data = await response.json();
                    currentData = data;
                    await startAnalysis(data);
                } else {
                    // Generate example data locally
                    currentData = generateExampleData();
                    await startAnalysis(currentData);
                }
            } catch (error) {
                // Generate example data locally
                currentData = generateExampleData();
                await startAnalysis(currentData);
            }
        }

        function generateExampleData() {
            return {
                conversations: [
                    { id: 1, text: "Customer support inquiry about billing", category: "Support", sentiment: 0.2, timestamp: Date.now() - 3600000 * 5 },
                    { id: 2, text: "Product feature request for dashboard", category: "Feature Request", sentiment: 0.8, timestamp: Date.now() - 3600000 * 4 },
                    { id: 3, text: "Technical issue with login system", category: "Bug Report", sentiment: -0.5, timestamp: Date.now() - 3600000 * 3 },
                    { id: 4, text: "Positive feedback about new update", category: "Feedback", sentiment: 0.9, timestamp: Date.now() - 3600000 * 2 },
                    { id: 5, text: "Question about pricing plans", category: "Sales", sentiment: 0.3, timestamp: Date.now() - 3600000 },
                    { id: 6, text: "Request for API documentation", category: "Support", sentiment: 0.4, timestamp: Date.now() - 3600000 * 7 },
                    { id: 7, text: "Complaint about slow performance", category: "Bug Report", sentiment: -0.7, timestamp: Date.now() - 3600000 * 6 },
                    { id: 8, text: "Praise for customer service", category: "Feedback", sentiment: 0.95, timestamp: Date.now() - 3600000 * 8 }
                ],
                clusters: [
                    { id: 1, name: "Support Issues", count: 15, description: "Customer support and technical problems" },
                    { id: 2, name: "Feature Requests", count: 8, description: "User suggestions and feature ideas" },
                    { id: 3, name: "Positive Feedback", count: 12, description: "Satisfied customer testimonials" },
                    { id: 4, name: "Sales Inquiries", count: 6, description: "Pricing and subscription questions" },
                    { id: 5, name: "Bug Reports", count: 9, description: "Technical issues and bugs" }
                ]
            };
        }

        // Analysis
        async function startAnalysis(data) {
            updateProgress(30, 'Generating embeddings...');
            await sleep(1000);
            
            updateProgress(60, 'Clustering conversations...');
            await sleep(1000);
            
            updateProgress(80, 'Extracting patterns...');
            await sleep(1000);
            
            updateProgress(100, 'Analysis complete!');
            await sleep(500);
            
            hideProgress();
            switchView('analysis');
            renderAnalysis();
        }

        function renderAnalysis() {
            if (!currentData) return;

            // Update metrics
            document.getElementById('totalConversations').textContent = 
                currentData.conversations?.length || 0;
            document.getElementById('totalClusters').textContent = 
                currentData.clusters?.length || 0;
            document.getElementById('avgSimilarity').textContent = '87%';
            document.getElementById('processingTime').textContent = 
                processingStartTime ? Math.round((Date.now() - processingStartTime) / 1000) + 's' : '0s';

            // Render clusters
            renderClusters();
            
            // Render visualization
            renderVisualization('scatter');
        }

        function renderClusters() {
            const clusterList = document.getElementById('clusterList');
            clusterList.innerHTML = '';

            if (!currentData?.clusters) return;

            currentData.clusters.forEach(cluster => {
                const clusterItem = document.createElement('div');
                clusterItem.className = 'cluster-item';
                clusterItem.innerHTML = `
                    <div class="cluster-header">
                        <span class="cluster-name">${cluster.name}</span>
                        <span class="cluster-count">${cluster.count}</span>
                    </div>
                    <div class="cluster-description">${cluster.description}</div>
                `;
                clusterItem.addEventListener('click', () => selectCluster(cluster));
                clusterList.appendChild(clusterItem);
            });
        }

        function selectCluster(cluster) {
            selectedCluster = cluster;
            
            // Update UI
            document.querySelectorAll('.cluster-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update details panel
            const detailsPanel = document.getElementById('detailsPanel');
            detailsPanel.innerHTML = `
                <h4 style="margin-bottom: 1rem;">${cluster.name}</h4>
                <div style="display: grid; gap: 0.75rem;">
                    <div style="padding: 0.75rem; background: var(--light); border-radius: 0.5rem;">
                        <div style="font-size: 0.85rem; color: var(--gray);">Conversations</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">${cluster.count}</div>
                    </div>
                    <div style="padding: 0.75rem; background: var(--light); border-radius: 0.5rem;">
                        <div style="font-size: 0.85rem; color: var(--gray);">Confidence</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">92%</div>
                    </div>
                </div>
                <p style="margin-top: 1rem; line-height: 1.5;">${cluster.description}</p>
            `;
        }

        // Visualizations
        function showViz(type) {
            // Update controls
            document.querySelectorAll('.viz-control').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Render visualization
            renderVisualization(type);
        }

        function renderVisualization(type) {
            const container = document.getElementById('vizContainer');
            container.innerHTML = '<div class="spinner"></div>';

            setTimeout(() => {
                if (type === 'scatter') {
                    renderScatterPlot(container);
                } else if (type === 'hierarchy') {
                    renderHierarchy(container);
                } else if (type === 'timeline') {
                    renderTimeline(container);
                } else if (type === 'heatmap') {
                    renderHeatmap(container);
                }
            }, 500);
        }

        function renderScatterPlot(container) {
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = 400;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Generate random points for demo
            const data = Array.from({length: 50}, () => ({
                x: Math.random() * width,
                y: Math.random() * height,
                cluster: Math.floor(Math.random() * 4)
            }));

            const colors = ['#4f46e5', '#06b6d4', '#10b981', '#f59e0b'];

            svg.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('r', 6)
                .attr('fill', d => colors[d.cluster])
                .attr('opacity', 0.7)
                .on('mouseover', function() {
                    d3.select(this).attr('r', 8).attr('opacity', 1);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 6).attr('opacity', 0.7);
                });
        }

        function renderHierarchy(container) {
            container.innerHTML = '';
            
            if (!currentData || !currentData.clusters) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem;">No data available for hierarchy visualization</p>';
                return;
            }
            
            const width = container.clientWidth;
            const height = 400;
            const margin = {top: 20, right: 90, bottom: 30, left: 90};
            
            // Create hierarchical data structure
            const hierarchyData = {
                name: "All Conversations",
                children: currentData.clusters.map(cluster => ({
                    name: cluster.name,
                    value: cluster.count,
                    description: cluster.description
                }))
            };
            
            const root = d3.hierarchy(hierarchyData)
                .sum(d => d.value || 0)
                .sort((a, b) => b.value - a.value);
            
            const treeLayout = d3.tree()
                .size([height - margin.top - margin.bottom, width - margin.left - margin.right]);
            
            treeLayout(root);
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Draw links
            g.selectAll('.link')
                .data(root.links())
                .enter().append('path')
                .attr('class', 'link')
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x))
                .style('fill', 'none')
                .style('stroke', '#ccc')
                .style('stroke-width', 2);
            
            // Draw nodes
            const node = g.selectAll('.node')
                .data(root.descendants())
                .enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.y},${d.x})`);
            
            node.append('circle')
                .attr('r', d => d.children ? 6 : 4)
                .style('fill', d => d.children ? '#4f46e5' : '#06b6d4')
                .style('stroke', '#fff')
                .style('stroke-width', 2);
            
            node.append('text')
                .attr('dy', '.35em')
                .attr('x', d => d.children ? -10 : 10)
                .style('text-anchor', d => d.children ? 'end' : 'start')
                .style('font-size', '12px')
                .text(d => d.data.name + (d.data.value ? ` (${d.data.value})` : ''));
            
            // Add hover effects
            node.on('mouseover', function(event, d) {
                d3.select(this).select('circle')
                    .transition()
                    .duration(200)
                    .attr('r', d => d.children ? 8 : 6);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).select('circle')
                    .transition()
                    .duration(200)
                    .attr('r', d => d.children ? 6 : 4);
            });
        }

        function renderTimeline(container) {
            container.innerHTML = '';
            
            if (!currentData || !currentData.conversations) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem;">No data available for timeline visualization</p>';
                return;
            }
            
            const width = container.clientWidth;
            const height = 400;
            const margin = {top: 20, right: 30, bottom: 40, left: 50};
            
            // Generate timeline data (simulating timestamps)
            const timelineData = currentData.conversations.map((conv, i) => {
                const baseTime = new Date();
                baseTime.setHours(baseTime.getHours() - (currentData.conversations.length - i) * 2);
                return {
                    time: baseTime,
                    value: conv.sentiment || Math.random(),
                    text: conv.text,
                    category: conv.category
                };
            });
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(timelineData, d => d.time))
                .range([0, width - margin.left - margin.right]);
            
            const yScale = d3.scaleLinear()
                .domain([-1, 1])
                .range([height - margin.top - margin.bottom, 0]);
            
            // Create line generator
            const line = d3.line()
                .x(d => xScale(d.time))
                .y(d => yScale(d.value))
                .curve(d3.curveMonotoneX);
            
            // Add X axis
            g.append('g')
                .attr('transform', `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(xScale)
                    .tickFormat(d3.timeFormat('%H:%M')));
            
            // Add Y axis
            g.append('g')
                .call(d3.axisLeft(yScale)
                    .tickValues([-1, -0.5, 0, 0.5, 1])
                    .tickFormat(d => d === 0 ? 'Neutral' : d > 0 ? 'Positive' : 'Negative'));
            
            // Add the line
            g.append('path')
                .datum(timelineData)
                .attr('fill', 'none')
                .attr('stroke', '#4f46e5')
                .attr('stroke-width', 2)
                .attr('d', line);
            
            // Add dots for each data point
            g.selectAll('.dot')
                .data(timelineData)
                .enter().append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.time))
                .attr('cy', d => yScale(d.value))
                .attr('r', 4)
                .attr('fill', d => d.value > 0 ? '#10b981' : d.value < 0 ? '#ef4444' : '#6b7280')
                .on('mouseover', function(event, d) {
                    // Show tooltip
                    const tooltip = d3.select('body').append('div')
                        .attr('class', 'tooltip')
                        .style('position', 'absolute')
                        .style('background', 'rgba(0,0,0,0.8)')
                        .style('color', 'white')
                        .style('padding', '8px')
                        .style('border-radius', '4px')
                        .style('font-size', '12px')
                        .style('pointer-events', 'none')
                        .style('opacity', 0);
                    
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    
                    tooltip.html(`${d.category || 'General'}<br/>Sentiment: ${d.value.toFixed(2)}`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.selectAll('.tooltip').remove();
                });
            
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Sentiment Timeline');
        }

        function renderHeatmap(container) {
            container.innerHTML = '';
            
            if (!currentData || !currentData.clusters) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem;">No data available for heatmap visualization</p>';
                return;
            }
            
            const width = container.clientWidth;
            const height = 400;
            const margin = {top: 50, right: 50, bottom: 50, left: 100};
            
            // Create similarity matrix data
            const categories = currentData.clusters.map(c => c.name);
            const matrixData = [];
            
            categories.forEach((cat1, i) => {
                categories.forEach((cat2, j) => {
                    // Generate similarity scores (in real app, this would come from backend)
                    const similarity = i === j ? 1 : Math.random() * 0.8;
                    matrixData.push({
                        x: cat2,
                        y: cat1,
                        value: similarity
                    });
                });
            });
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create scales
            const xScale = d3.scaleBand()
                .domain(categories)
                .range([0, width - margin.left - margin.right])
                .padding(0.05);
            
            const yScale = d3.scaleBand()
                .domain(categories)
                .range([0, height - margin.top - margin.bottom])
                .padding(0.05);
            
            const colorScale = d3.scaleSequential()
                .domain([0, 1])
                .interpolator(d3.interpolateBlues);
            
            // Add X axis
            g.append('g')
                .attr('transform', `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');
            
            // Add Y axis
            g.append('g')
                .call(d3.axisLeft(yScale));
            
            // Add heatmap cells
            g.selectAll('.cell')
                .data(matrixData)
                .enter().append('rect')
                .attr('x', d => xScale(d.x))
                .attr('y', d => yScale(d.y))
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .style('fill', d => colorScale(d.value))
                .style('stroke', 'white')
                .style('stroke-width', 1)
                .on('mouseover', function(event, d) {
                    // Show tooltip
                    const tooltip = d3.select('body').append('div')
                        .attr('class', 'tooltip')
                        .style('position', 'absolute')
                        .style('background', 'rgba(0,0,0,0.8)')
                        .style('color', 'white')
                        .style('padding', '8px')
                        .style('border-radius', '4px')
                        .style('font-size', '12px')
                        .style('pointer-events', 'none')
                        .style('opacity', 0);
                    
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    
                    tooltip.html(`${d.y} ‚Üî ${d.x}<br/>Similarity: ${(d.value * 100).toFixed(0)}%`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.selectAll('.tooltip').remove();
                });
            
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Cluster Similarity Heatmap');
            
            // Add color legend
            const legendWidth = 200;
            const legendHeight = 20;
            
            const legendScale = d3.scaleLinear()
                .domain([0, 1])
                .range([0, legendWidth]);
            
            const legendAxis = d3.axisBottom(legendScale)
                .ticks(5)
                .tickFormat(d => `${(d * 100).toFixed(0)}%`);
            
            const legend = svg.append('g')
                .attr('transform', `translate(${width - margin.right - legendWidth - 20}, 20)`);
            
            // Create gradient for legend
            const gradientId = 'heatmap-gradient';
            const gradient = svg.append('defs')
                .append('linearGradient')
                .attr('id', gradientId)
                .attr('x1', '0%')
                .attr('x2', '100%')
                .attr('y1', '0%')
                .attr('y2', '0%');
            
            for (let i = 0; i <= 10; i++) {
                gradient.append('stop')
                    .attr('offset', `${i * 10}%`)
                    .attr('stop-color', colorScale(i / 10));
            }
            
            legend.append('rect')
                .attr('width', legendWidth)
                .attr('height', legendHeight)
                .style('fill', `url(#${gradientId})`);
            
            legend.append('g')
                .attr('transform', `translate(0, ${legendHeight})`)
                .call(legendAxis);
        }

        // Patterns View
        function renderPatterns() {
            const content = document.getElementById('patternsContent');
            
            if (!currentData || !currentData.clusters) {
                content.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">No pattern data available. Please analyze conversations first.</p>';
                return;
            }
            
            // Extract patterns from clusters
            const topics = {};
            const sentiments = { positive: 0, neutral: 0, negative: 0 };
            const keywords = {};
            
            // Process clusters to find patterns
            currentData.clusters.forEach(cluster => {
                topics[cluster.name] = cluster.count;
            });
            
            // Process conversations for sentiment and keywords
            if (currentData.conversations) {
                currentData.conversations.forEach(conv => {
                    // Analyze sentiment
                    const sentiment = conv.sentiment || 0;
                    if (sentiment > 0.3) sentiments.positive++;
                    else if (sentiment < -0.3) sentiments.negative++;
                    else sentiments.neutral++;
                    
                    // Extract keywords (simple word frequency)
                    const words = (conv.text || '').toLowerCase().split(/\s+/);
                    words.forEach(word => {
                        if (word.length > 4) { // Only count words longer than 4 chars
                            keywords[word] = (keywords[word] || 0) + 1;
                        }
                    });
                });
            }
            
            // Sort topics by count
            const sortedTopics = Object.entries(topics)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            // Sort keywords by frequency
            const topKeywords = Object.entries(keywords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Calculate percentages
            const total = currentData.conversations?.length || 1;
            const totalTopics = Object.values(topics).reduce((a, b) => a + b, 0) || 1;
            
            content.innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <div class="metric-card">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Discovered Topics</h4>
                        <ul style="margin-top: 0.5rem; list-style: none;">
                            ${sortedTopics.map(([topic, count]) => `
                                <li style="margin-bottom: 0.5rem; display: flex; align-items: center;">
                                    <span style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-right: 0.5rem;"></span>
                                    <span style="flex: 1;">${topic}</span>
                                    <span style="color: var(--gray);">${((count / totalTopics) * 100).toFixed(0)}%</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="metric-card">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Sentiment Analysis</h4>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üòä Positive</span>
                                <span>${((sentiments.positive / total) * 100).toFixed(0)}%</span>
                            </div>
                            <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #10b981; height: 100%; width: ${(sentiments.positive / total) * 100}%;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üòê Neutral</span>
                                <span>${((sentiments.neutral / total) * 100).toFixed(0)}%</span>
                            </div>
                            <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #6b7280; height: 100%; width: ${(sentiments.neutral / total) * 100}%;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üòü Negative</span>
                                <span>${((sentiments.negative / total) * 100).toFixed(0)}%</span>
                            </div>
                            <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #ef4444; height: 100%; width: ${(sentiments.negative / total) * 100}%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Top Keywords</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${topKeywords.map(([word, count]) => `
                                <span style="padding: 0.25rem 0.75rem; background: var(--light); border-radius: 1rem; font-size: 0.85rem;">
                                    ${word} <span style="color: var(--gray);">(${count})</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Pattern Insights</h4>
                        <ul style="list-style: none; line-height: 1.8;">
                            <li>üìä <strong>${sortedTopics.length}</strong> distinct conversation patterns identified</li>
                            <li>üîÑ <strong>${((sentiments.positive / total) * 100).toFixed(0)}%</strong> positive sentiment overall</li>
                            <li>üìà Most common topic: <strong>${sortedTopics[0] ? sortedTopics[0][0] : 'N/A'}</strong></li>
                            <li>üîë Top keyword: <strong>${topKeywords[0] ? topKeywords[0][0] : 'N/A'}</strong></li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Insights View
        function renderInsights() {
            const content = document.getElementById('insightsContent');
            
            if (!currentData || !currentData.clusters) {
                content.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">No insights available. Please analyze conversations first.</p>';
                return;
            }
            
            // Generate insights from data
            const insights = [];
            const total = currentData.conversations?.length || 0;
            
            // Analyze clusters for insights
            if (currentData.clusters && currentData.clusters.length > 0) {
                // Find largest cluster
                const largestCluster = currentData.clusters.reduce((prev, current) => 
                    (prev.count > current.count) ? prev : current
                );
                
                insights.push({
                    title: 'Dominant Pattern',
                    description: `The largest conversation cluster is "${largestCluster.name}" with ${largestCluster.count} conversations (${((largestCluster.count / total) * 100).toFixed(0)}% of total)`,
                    type: 'pattern',
                    icon: 'üéØ'
                });
                
                // Cluster distribution insight
                const avgClusterSize = currentData.clusters.reduce((sum, c) => sum + c.count, 0) / currentData.clusters.length;
                insights.push({
                    title: 'Conversation Distribution',
                    description: `Conversations are grouped into ${currentData.clusters.length} distinct patterns with an average of ${avgClusterSize.toFixed(0)} conversations per cluster`,
                    type: 'distribution',
                    icon: 'üìä'
                });
            }
            
            // Analyze sentiment trends
            if (currentData.conversations) {
                const sentiments = currentData.conversations.map(c => c.sentiment || 0);
                const avgSentiment = sentiments.reduce((a, b) => a + b, 0) / sentiments.length;
                const positivePct = (sentiments.filter(s => s > 0.3).length / sentiments.length * 100).toFixed(0);
                
                insights.push({
                    title: 'Sentiment Overview',
                    description: `Overall sentiment is ${avgSentiment > 0 ? 'positive' : avgSentiment < 0 ? 'negative' : 'neutral'} with ${positivePct}% positive conversations`,
                    type: 'sentiment',
                    icon: avgSentiment > 0 ? 'üòä' : avgSentiment < 0 ? 'üòü' : 'üòê'
                });
                
                // Find outliers
                const outliers = sentiments.filter(s => Math.abs(s) > 0.8).length;
                if (outliers > 0) {
                    insights.push({
                        title: 'Strong Reactions',
                        description: `${outliers} conversations (${((outliers / total) * 100).toFixed(0)}%) show strong emotional responses that may require attention`,
                        type: 'alert',
                        icon: '‚ö°'
                    });
                }
            }
            
            // Category-based insights
            if (currentData.conversations) {
                const categories = {};
                currentData.conversations.forEach(conv => {
                    const cat = conv.category || 'Uncategorized';
                    categories[cat] = (categories[cat] || 0) + 1;
                });
                
                const topCategory = Object.entries(categories)
                    .sort((a, b) => b[1] - a[1])[0];
                
                if (topCategory) {
                    insights.push({
                        title: 'Primary Focus Area',
                        description: `"${topCategory[0]}" is the most frequent conversation type, appearing in ${topCategory[1]} conversations`,
                        type: 'category',
                        icon: 'üîç'
                    });
                }
            }
            
            // Actionable recommendations
            const recommendations = [];
            
            if (insights.find(i => i.type === 'sentiment' && i.description.includes('negative'))) {
                recommendations.push({
                    title: 'Improve Sentiment',
                    action: 'Focus on addressing negative feedback patterns to improve overall satisfaction',
                    priority: 'high'
                });
            }
            
            if (currentData.clusters && currentData.clusters.length > 10) {
                recommendations.push({
                    title: 'Simplify Patterns',
                    action: 'Consider consolidating similar conversation patterns for better management',
                    priority: 'medium'
                });
            }
            
            if (insights.find(i => i.type === 'alert')) {
                recommendations.push({
                    title: 'Address Outliers',
                    action: 'Review conversations with extreme sentiment scores for immediate action items',
                    priority: 'high'
                });
            }
            
            content.innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">Key Insights</h3>
                        <div style="display: grid; gap: 1rem;">
                            ${insights.map(insight => `
                                <div class="metric-card" style="border-left: 4px solid ${insight.type === 'alert' ? 'var(--warning)' : 'var(--primary)'};">
                                    <h4 style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.5rem;">${insight.icon}</span>
                                        ${insight.title}
                                    </h4>
                                    <p style="margin-top: 0.5rem; line-height: 1.6;">${insight.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${recommendations.length > 0 ? `
                        <div>
                            <h3 style="margin-bottom: 1rem; color: var(--primary);">Recommendations</h3>
                            <div style="display: grid; gap: 1rem;">
                                ${recommendations.map(rec => `
                                    <div class="metric-card" style="border-left: 4px solid ${rec.priority === 'high' ? 'var(--danger)' : 'var(--warning)'};">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <h4>${rec.title}</h4>
                                            <span style="padding: 0.25rem 0.5rem; background: ${rec.priority === 'high' ? 'var(--danger)' : 'var(--warning)'}; color: white; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase;">
                                                ${rec.priority}
                                            </span>
                                        </div>
                                        <p style="margin-top: 0.5rem; line-height: 1.6;">${rec.action}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="metric-card" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                        <h4 style="color: white;">Analysis Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div style="font-size: 2rem; font-weight: bold;">${currentData.conversations?.length || 0}</div>
                                <div style="opacity: 0.9;">Total Conversations</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: bold;">${currentData.clusters?.length || 0}</div>
                                <div style="opacity: 0.9;">Patterns Found</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: bold;">${insights.length}</div>
                                <div style="opacity: 0.9;">Key Insights</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Paste Data
        function showPasteDialog() {
            document.getElementById('pasteModal').classList.add('active');
        }

        async function processPastedData() {
            const input = document.getElementById('pasteInput').value;
            if (!input.trim()) return;

            try {
                const data = JSON.parse(input);
                currentData = data;
                closeModal('pasteModal');
                await startAnalysis(data);
            } catch (error) {
                alert('Invalid JSON format. Please check your data and try again.');
            }
        }

        // Settings
        function saveSettings() {
            const settings = {
                provider: document.getElementById('providerSelect').value,
                model: document.getElementById('modelInput').value,
                batchSize: document.getElementById('batchSizeInput').value
            };
            
            localStorage.setItem('briefx-settings', JSON.stringify(settings));
            alert('Settings saved successfully!');
        }

        // Progress Management
        function showProgress(text) {
            const container = document.getElementById('progressContainer');
            container.classList.add('active');
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            if (text) {
                document.getElementById('progressText').textContent = text;
            }
        }

        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('active');
        }

        // Modal Management
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Recent Projects
        function loadRecentProjects() {
            const container = document.getElementById('recentProjects');
            const projects = JSON.parse(localStorage.getItem('briefx-projects') || '[]');
            
            if (projects.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No recent projects</p>';
                return;
            }

            projects.slice(0, 3).forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'upload-card';
                projectCard.style.cssText = 'cursor: pointer; padding: 1rem;';
                projectCard.innerHTML = `
                    <h4>${project.name}</h4>
                    <p style="font-size: 0.85rem; color: var(--gray);">${project.date}</p>
                `;
                projectCard.addEventListener('click', () => loadProject(project));
                container.appendChild(projectCard);
            });
        }

        function loadProject(project) {
            currentData = project.data;
            switchView('analysis');
            renderAnalysis();
        }

        function newProject() {
            currentData = null;
            selectedCluster = null;
            switchView('upload');
        }

        function showHelp() {
            alert('BriefX Help\n\n1. Upload your conversation data\n2. Wait for analysis to complete\n3. Explore clusters and patterns\n4. Export insights for action');
        }

        // Utility Functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>