<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BriefX - Unified Analysis Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* BriefcaseBrain design tokens */
            --primary: #3388ff;
            --primary-dark: #4151da;
            --primary-light: #ebf4ff;
            --primary-muted: rgba(51,136,255,0.12);
            --secondary: #0d0d12;
            --success: #00811a;
            --success-light: #ecfaec;
            --warning: #c47100;
            --warning-light: #fff9ed;
            --danger: #eb6131;
            --danger-light: #fff5f5;
            --dark: #0d0d12;
            --navy: #0d0d12;
            --navy-dark: #03152f;
            --navy-mid: #0a0a0b;
            --navy-light: #2c2c2e;
            --gray: #a0a0a8;
            --gray-medium: #55555e;
            --light: #f7f7f7;
            --light-off: #fafafa;
            --white: #ffffff;
            --border: #eeeff2;
            --border-medium: #e3e3e8;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 16px rgba(74,127,255,0.3);
            --shadow-lg: 0 8px 28px rgba(74,127,255,0.4);
            --shadow-xl: 0 24px 80px rgba(0,0,0,0.1), 0 4px 16px rgba(0,0,0,0.05);
            --gradient-primary: linear-gradient(172deg, #3388ff 0%, #4151da 100%);
            --gradient-footer: linear-gradient(180deg, #f5faff, #fdf6ff);
            --radius-sm: 6px;
            --radius: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            --radius-full: 9999px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f7f7f7;
            min-height: 100vh;
            color: var(--dark);
        }

        /* Navigation Bar - BriefcaseBrain dark nav style */
        .navbar {
            background: var(--navy);
            padding: 0.75rem 2rem;
            box-shadow: 0 1px 0 rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
        }

        .nav-brand .nav-brand-accent {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: rgba(227,227,232,0.7);
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            color: var(--white);
            background: rgba(255,255,255,0.08);
        }

        .nav-tab.active {
            color: var(--white);
            background: rgba(51,136,255,0.15);
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1.25rem;
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.25s ease;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--white);
            border: 1px solid rgba(255,255,255,0.15);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.18);
            border-color: rgba(255,255,255,0.25);
        }

        /* Main Container */
        .main-container {
            margin-top: 60px;
            padding: 2rem;
            min-height: calc(100vh - 60px);
        }

        /* View Sections */
        .view-section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Upload View */
        .upload-container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }

        .upload-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .upload-header h1 {
            font-size: 2rem;
            color: var(--navy);
            margin-bottom: 0.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .upload-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .upload-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 1px solid var(--border);
        }

        .upload-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .upload-card-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .upload-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--navy);
            font-weight: 600;
        }

        .upload-card p {
            font-size: 0.875rem;
            color: var(--gray-medium);
        }

        /* Analysis View */
        .analysis-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 1.5rem;
            height: calc(100vh - 100px);
        }

        .sidebar {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .main-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--light);
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            border-left: 3px solid var(--primary);
            border: 1px solid var(--border);
            border-left: 3px solid var(--primary);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-top: 0.25rem;
        }

        /* Visualization Container */
        .viz-container {
            background: var(--light);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-top: 1.5rem;
            min-height: 400px;
            border: 1px solid var(--border);
        }

        .viz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .viz-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--navy);
            letter-spacing: -0.01em;
        }

        .viz-controls {
            display: flex;
            gap: 0.375rem;
        }

        .viz-control {
            padding: 0.25rem 0.75rem;
            background: var(--white);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .viz-control:hover {
            background: var(--primary-muted);
            color: var(--primary);
            border-color: var(--primary);
        }

        .viz-control.active {
            background: var(--gradient-primary);
            color: var(--white);
            border-color: transparent;
            box-shadow: var(--shadow-md);
        }

        /* Cluster List */
        .cluster-list {
            margin-top: 1rem;
        }

        .cluster-item {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .cluster-item:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .cluster-item.active {
            background: var(--gradient-primary);
            color: var(--white);
            border-color: transparent;
            box-shadow: var(--shadow-md);
        }

        .cluster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .cluster-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .cluster-count {
            background: var(--light);
            padding: 0.15rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .cluster-item.active .cluster-count {
            background: rgba(255,255,255,0.2);
            color: var(--white);
        }

        .cluster-description {
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.4;
        }

        .cluster-item.active .cluster-description {
            color: rgba(255,255,255,0.9);
        }

        /* Progress Indicator */
        .progress-container {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            display: none;
            z-index: 900;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            background: var(--light);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            background: var(--gradient-primary);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        /* File Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--light);
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .drop-zone.active {
            border-color: var(--primary);
            background: var(--primary-muted);
        }

        .drop-zone-icon {
            font-size: 3rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .drop-zone-text {
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .drop-zone-hint {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .analysis-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0.75rem 1rem;
            }
            
            .nav-tabs {
                display: none;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .upload-options {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background: var(--dark);
            color: var(--white);
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Clio-specific styles */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .clio-pattern-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .clio-pattern-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .privacy-score {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .privacy-score.high {
            background: var(--success-light);
            color: var(--success);
        }

        .privacy-score.medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .privacy-score.low {
            background: var(--danger-light);
            color: var(--danger);
        }

        .clio-search-result {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .clio-search-result:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <span>üíº</span>
            <span><span class="nav-brand-accent">Brief</span>X</span>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-view="upload">Upload</button>
            <button class="nav-tab" data-view="analysis">Analysis</button>
            <button class="nav-tab" data-view="clio">Clio</button>
            <button class="nav-tab" data-view="patterns">Patterns</button>
            <button class="nav-tab" data-view="insights">Insights</button>
            <button class="nav-tab" data-view="settings">Settings</button>
        </div>
        <div class="nav-actions">
            <button class="btn btn-secondary" onclick="showHelp()">Help</button>
            <button class="btn btn-primary" onclick="newProject()">New Project</button>
        </div>
    </nav>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-text" id="progressText">Processing...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Upload View -->
        <div class="view-section active" id="uploadView">
            <div class="upload-container">
                <div class="upload-header">
                    <h1>Start Your Analysis</h1>
                    <p>Choose how you'd like to import your conversation data</p>
                </div>
                
                <div class="upload-options">
                    <div class="upload-card" onclick="showFileUpload()">
                        <div class="upload-card-icon">üìÅ</div>
                        <h3>Upload Files</h3>
                        <p>JSON, CSV, Parquet, PDF, TXT</p>
                    </div>
                    
                    <div class="upload-card" onclick="useExampleData()">
                        <div class="upload-card-icon">üé≤</div>
                        <h3>Example Data</h3>
                        <p>Try with sample conversations</p>
                    </div>
                    
                    <div class="upload-card" onclick="showPasteDialog()">
                        <div class="upload-card-icon">üìã</div>
                        <h3>Paste Data</h3>
                        <p>Paste JSON or text directly</p>
                    </div>
                </div>

                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                    <h2 style="font-size: 1.3rem; margin-bottom: 1rem;">Recent Projects</h2>
                    <div id="recentProjects" style="display: grid; gap: 1rem;">
                        <!-- Recent projects will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis View -->
        <div class="view-section" id="analysisView">
            <div class="analysis-container">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <h3 style="margin-bottom: 1rem;">Clusters</h3>
                    <div class="cluster-list" id="clusterList">
                        <!-- Clusters will be loaded here -->
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="main-content">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Conversations</div>
                            <div class="metric-value" id="totalConversations">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Clusters Found</div>
                            <div class="metric-value" id="totalClusters">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Similarity</div>
                            <div class="metric-value" id="avgSimilarity">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Processing Time</div>
                            <div class="metric-value" id="processingTime">0s</div>
                        </div>
                    </div>

                    <div class="viz-container">
                        <div class="viz-header">
                            <h3 class="viz-title">Cluster Visualization</h3>
                            <div class="viz-controls">
                                <button class="viz-control active" onclick="showViz('scatter')">Scatter</button>
                                <button class="viz-control" onclick="showViz('hierarchy')">Hierarchy</button>
                                <button class="viz-control" onclick="showViz('timeline')">Timeline</button>
                                <button class="viz-control" onclick="showViz('heatmap')">Heatmap</button>
                            </div>
                        </div>
                        <div id="vizContainer" style="min-height: 400px;">
                            <!-- Visualization will be rendered here -->
                        </div>
                    </div>
                </main>

                <!-- Right Panel -->
                <aside class="sidebar">
                    <h3 style="margin-bottom: 1rem;">Details</h3>
                    <div id="detailsPanel">
                        <p style="color: var(--gray); text-align: center; padding: 2rem;">
                            Select a cluster to view details
                        </p>
                    </div>
                </aside>
            </div>
        </div>

        <!-- Patterns View -->
        <div class="view-section" id="patternsView">
            <div class="upload-container">
                <h2>Pattern Discovery</h2>
                <p>Analyzing recurring themes and patterns in your data...</p>
                <div id="patternsContent" style="margin-top: 2rem;">
                    <!-- Patterns will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Insights View -->
        <div class="view-section" id="insightsView">
            <div class="upload-container">
                <h2>Key Insights</h2>
                <p>Actionable insights derived from your conversation analysis</p>
                <div id="insightsContent" style="margin-top: 2rem;">
                    <!-- Insights will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Clio View -->
        <div class="view-section" id="clioView">
            <div class="upload-container">
                <div class="upload-header">
                    <h1>Clio Methodology</h1>
                    <p>Privacy-preserving conversation analysis with advanced clustering</p>
                </div>
                
                <div id="clioContent">
                    <!-- Clio Configuration Panel -->
                    <div style="background: #f8fafc; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1.5rem; color: var(--primary);">Privacy & Analysis Configuration</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h4 style="margin-bottom: 1rem;">Privacy Settings</h4>
                                <div style="display: grid; gap: 1rem;">
                                    <label>
                                        <span style="display: block; margin-bottom: 0.5rem;">K-Anonymity Level</span>
                                        <input type="number" id="kAnonymity" value="5" min="2" max="20" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                        <small style="color: var(--gray);">Minimum group size for anonymization</small>
                                    </label>
                                    <label>
                                        <span style="display: block; margin-bottom: 0.5rem;">Privacy Level</span>
                                        <select id="privacyLevel" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                            <option value="standard">Standard</option>
                                            <option value="high">High</option>
                                            <option value="maximum">Maximum</option>
                                        </select>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="removePII" checked>
                                        <span>Remove Personal Identifiable Information (PII)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="redactSensitive" checked>
                                        <span>Redact Sensitive Content</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1rem;">Clustering Configuration</h4>
                                <div style="display: grid; gap: 1rem;">
                                    <label>
                                        <span style="display: block; margin-bottom: 0.5rem;">Clustering Algorithm</span>
                                        <select id="clusteringAlgorithm" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                            <option value="auto">Auto-Select</option>
                                            <option value="dbscan">DBSCAN</option>
                                            <option value="hierarchical">Hierarchical</option>
                                        </select>
                                    </label>
                                    <label>
                                        <span style="display: block; margin-bottom: 0.5rem;">Min Cluster Size</span>
                                        <input type="number" id="minClusterSize" value="10" min="5" max="50" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                    </label>
                                    <label>
                                        <span style="display: block; margin-bottom: 0.5rem;">Max Hierarchy Depth</span>
                                        <input type="number" id="maxHierarchyDepth" value="5" min="2" max="10" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                    </label>
                                    <label>
                                        <span style="display: block; margin-bottom: 0.5rem;">Pattern Threshold</span>
                                        <input type="number" id="patternThreshold" value="0.3" min="0.1" max="1.0" step="0.1" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 2rem;">
                            <button class="btn btn-primary" onclick="startClioAnalysis()" id="clioAnalyzeBtn">
                                Start Clio Analysis
                            </button>
                            <button class="btn btn-secondary" onclick="loadPrivacyConfig()" style="margin-left: 1rem;">
                                Load Default Config
                            </button>
                        </div>
                    </div>

                    <!-- Clio Results Panel -->
                    <div id="clioResults" style="display: none;">
                        <!-- Analysis Status -->
                        <div id="clioStatus" style="background: #fff; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Analysis Status</h3>
                            <div id="clioStatusContent">
                                <div class="loading-spinner" style="text-align: center; padding: 2rem;">
                                    <div style="border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                                    <p style="margin-top: 1rem;">Processing with Clio methodology...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Privacy Audit Results -->
                        <div id="privacyAudit" style="background: #fff; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; display: none;">
                            <h3 style="margin-bottom: 1rem; color: var(--success);">üõ°Ô∏è Privacy Audit Results</h3>
                            <div id="privacyAuditContent">
                                <!-- Privacy audit details will be loaded here -->
                            </div>
                        </div>

                        <!-- Cluster Hierarchy -->
                        <div id="clioHierarchy" style="background: #fff; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; display: none;">
                            <h3 style="margin-bottom: 1rem;">üå≥ Conversation Hierarchy</h3>
                            <div id="hierarchyVisualization">
                                <!-- D3.js hierarchy visualization will be rendered here -->
                            </div>
                        </div>

                        <!-- Pattern Discovery -->
                        <div id="clioPatterns" style="background: #fff; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; display: none;">
                            <h3 style="margin-bottom: 1rem;">üîç Discovered Patterns</h3>
                            <div id="patternsGrid" style="display: grid; gap: 1rem;">
                                <!-- Pattern cards will be loaded here -->
                            </div>
                        </div>

                        <!-- Investigation Tools -->
                        <div id="clioInvestigation" style="background: #fff; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 2rem; display: none;">
                            <h3 style="margin-bottom: 1rem;">üîé Investigation Tools</h3>
                            <div style="margin-bottom: 2rem;">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <input type="text" id="clioSearchQuery" placeholder="Search clusters..." 
                                           style="flex: 1; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                    <button class="btn btn-primary" onclick="searchClioClusters()">Search</button>
                                </div>
                                <div id="investigationSuggestions" style="margin-bottom: 1rem;">
                                    <p style="margin-bottom: 0.5rem; color: var(--gray);">Quick investigations:</p>
                                    <div id="suggestionButtons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <!-- Suggestion buttons will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            <div id="searchResults">
                                <!-- Search results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div class="view-section" id="settingsView">
            <div class="upload-container">
                <h2>Settings</h2>
                <div style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Analysis Configuration</h3>
                    <div style="display: grid; gap: 1rem;">
                        <label>
                            <span style="display: block; margin-bottom: 0.5rem;">Provider</span>
                            <select id="providerSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                                <option value="openai">OpenAI</option>
                                <option value="ollama">Ollama (Local)</option>
                                <option value="vllm">vLLM</option>
                            </select>
                        </label>
                        <label>
                            <span style="display: block; margin-bottom: 0.5rem;">Model</span>
                            <input type="text" id="modelInput" value="gpt-4o-mini" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                        </label>
                        <label>
                            <span style="display: block; margin-bottom: 0.5rem;">Batch Size</span>
                            <input type="number" id="batchSizeInput" value="100" min="1" max="1000" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                        </label>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 1.5rem;" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div class="modal" id="fileUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Upload Files</h2>
                <button class="modal-close" onclick="closeModal('fileUploadModal')">√ó</button>
            </div>
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">üì§</div>
                <div class="drop-zone-text">Drop files here or click to browse</div>
                <div class="drop-zone-hint">Supports JSON, CSV, Parquet, PDF, TXT files</div>
                <input type="file" id="fileInput" multiple accept=".json,.csv,.parquet,.pdf,.txt" style="display: none;">
            </div>
            <div id="fileList" style="margin-top: 1rem;"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="processFiles()">Process Files</button>
        </div>
    </div>

    <!-- Paste Data Modal -->
    <div class="modal" id="pasteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Paste Data</h2>
                <button class="modal-close" onclick="closeModal('pasteModal')">√ó</button>
            </div>
            <textarea id="pasteInput" style="width: 100%; min-height: 300px; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-family: monospace;" placeholder="Paste your JSON data here..."></textarea>
            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="processPastedData()">Process Data</button>
        </div>
    </div>

    <script>
        // State Management
        let currentView = 'upload';
        let currentData = null;
        let currentClusters = [];
        let selectedCluster = null;
        let processingStartTime = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadRecentProjects();
            // Initialize with example data for immediate visualization
            initializeWithExampleData();
        });

        // Initialize with example data
        function initializeWithExampleData() {
            // Set example data immediately for visualizations
            currentData = generateExampleData();
            // Don't switch views or start analysis, just have data ready
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchView(e.target.dataset.view);
                });
            });

            // File drop zone
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('active');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // View Management
        function switchView(viewName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === viewName);
            });

            // Update view sections
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewName + 'View').classList.add('active');

            currentView = viewName;

            // Load view-specific data
            if (viewName === 'analysis' && currentData) {
                renderAnalysis();
            } else if (viewName === 'patterns' && currentData) {
                renderPatterns();
            } else if (viewName === 'insights' && currentData) {
                renderInsights();
            }
        }

        // File Handling
        function showFileUpload() {
            document.getElementById('fileUploadModal').classList.add('active');
        }

        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            Array.from(files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'padding: 0.5rem; background: var(--light); border-radius: 0.25rem; margin-bottom: 0.5rem;';
                fileItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${file.name}</span>
                        <span style="color: var(--gray); font-size: 0.85rem;">${(file.size / 1024).toFixed(1)} KB</span>
                    </div>
                `;
                fileList.appendChild(fileItem);
            });
        }

        async function processFiles() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) return;

            closeModal('fileUploadModal');
            showProgress('Processing files...');

            // Simulate file processing
            processingStartTime = Date.now();
            
            // Read and process files
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            try {
                // Step 1: Upload files
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (uploadResponse.ok) {
                    const uploadData = await uploadResponse.json();
                    
                    // Step 2: Process conversations to get clusters
                    if (uploadData.data && uploadData.data.conversations) {
                        showProgress('Processing conversations...');
                        
                        const processResponse = await fetch('/api/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                conversations: uploadData.data.conversations
                            })
                        });
                        
                        if (processResponse.ok) {
                            const processedData = await processResponse.json();
                            if (processedData.success && processedData.data) {
                                currentData = processedData.data;
                                await startAnalysis(processedData.data);
                            } else {
                                // Fallback if processing fails
                                await useExampleData();
                            }
                        } else {
                            // Fallback if processing fails
                            await useExampleData();
                        }
                    } else {
                        // No conversations in upload response
                        await useExampleData();
                    }
                } else {
                    // Fallback to example data for demo
                    await useExampleData();
                }
            } catch (error) {
                console.error('Error processing files:', error);
                // Fallback to example data for demo
                await useExampleData();
            }
        }

        // Example Data
        async function useExampleData() {
            showProgress('Loading example data...');
            processingStartTime = Date.now();

            try {
                const response = await fetch('/api/example');
                if (response.ok) {
                    const data = await response.json();
                    currentData = data;
                    await startAnalysis(data);
                } else {
                    // Generate example data locally
                    currentData = generateExampleData();
                    await startAnalysis(currentData);
                }
            } catch (error) {
                // Generate example data locally
                currentData = generateExampleData();
                await startAnalysis(currentData);
            }
        }

        function generateExampleData() {
            return {
                conversations: [
                    { id: 1, text: "Customer support inquiry about billing", category: "Support", sentiment: 0.2, timestamp: Date.now() - 3600000 * 5 },
                    { id: 2, text: "Product feature request for dashboard", category: "Feature Request", sentiment: 0.8, timestamp: Date.now() - 3600000 * 4 },
                    { id: 3, text: "Technical issue with login system", category: "Bug Report", sentiment: -0.5, timestamp: Date.now() - 3600000 * 3 },
                    { id: 4, text: "Positive feedback about new update", category: "Feedback", sentiment: 0.9, timestamp: Date.now() - 3600000 * 2 },
                    { id: 5, text: "Question about pricing plans", category: "Sales", sentiment: 0.3, timestamp: Date.now() - 3600000 },
                    { id: 6, text: "Request for API documentation", category: "Support", sentiment: 0.4, timestamp: Date.now() - 3600000 * 7 },
                    { id: 7, text: "Complaint about slow performance", category: "Bug Report", sentiment: -0.7, timestamp: Date.now() - 3600000 * 6 },
                    { id: 8, text: "Praise for customer service", category: "Feedback", sentiment: 0.95, timestamp: Date.now() - 3600000 * 8 }
                ],
                clusters: [
                    { id: 1, name: "Support Issues", count: 15, description: "Customer support and technical problems" },
                    { id: 2, name: "Feature Requests", count: 8, description: "User suggestions and feature ideas" },
                    { id: 3, name: "Positive Feedback", count: 12, description: "Satisfied customer testimonials" },
                    { id: 4, name: "Sales Inquiries", count: 6, description: "Pricing and subscription questions" },
                    { id: 5, name: "Bug Reports", count: 9, description: "Technical issues and bugs" }
                ]
            };
        }

        // Analysis
        async function startAnalysis(data) {
            updateProgress(30, 'Generating embeddings...');
            await sleep(1000);
            
            updateProgress(60, 'Clustering conversations...');
            await sleep(1000);
            
            updateProgress(80, 'Extracting patterns...');
            await sleep(1000);
            
            updateProgress(100, 'Analysis complete!');
            await sleep(500);
            
            hideProgress();
            switchView('analysis');
            renderAnalysis();
        }

        function renderAnalysis() {
            if (!currentData) return;

            // Update metrics
            document.getElementById('totalConversations').textContent = 
                currentData.conversations?.length || 0;
            document.getElementById('totalClusters').textContent = 
                currentData.clusters?.length || 0;
            document.getElementById('avgSimilarity').textContent = '87%';
            document.getElementById('processingTime').textContent = 
                processingStartTime ? Math.round((Date.now() - processingStartTime) / 1000) + 's' : '0s';

            // Render clusters
            renderClusters();
            
            // Render visualization
            renderVisualization('scatter');
        }

        function renderClusters() {
            const clusterList = document.getElementById('clusterList');
            clusterList.innerHTML = '';

            if (!currentData?.clusters) return;

            currentData.clusters.forEach(cluster => {
                const clusterItem = document.createElement('div');
                clusterItem.className = 'cluster-item';
                clusterItem.innerHTML = `
                    <div class="cluster-header">
                        <span class="cluster-name">${cluster.name}</span>
                        <span class="cluster-count">${cluster.count}</span>
                    </div>
                    <div class="cluster-description">${cluster.description}</div>
                `;
                clusterItem.addEventListener('click', () => selectCluster(cluster));
                clusterList.appendChild(clusterItem);
            });
        }

        function selectCluster(cluster) {
            selectedCluster = cluster;
            
            // Update UI
            document.querySelectorAll('.cluster-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update details panel
            const detailsPanel = document.getElementById('detailsPanel');
            detailsPanel.innerHTML = `
                <h4 style="margin-bottom: 1rem;">${cluster.name}</h4>
                <div style="display: grid; gap: 0.75rem;">
                    <div style="padding: 0.75rem; background: var(--light); border-radius: 0.5rem;">
                        <div style="font-size: 0.85rem; color: var(--gray);">Conversations</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">${cluster.count}</div>
                    </div>
                    <div style="padding: 0.75rem; background: var(--light); border-radius: 0.5rem;">
                        <div style="font-size: 0.85rem; color: var(--gray);">Confidence</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">92%</div>
                    </div>
                </div>
                <p style="margin-top: 1rem; line-height: 1.5;">${cluster.description}</p>
            `;
        }

        // Visualizations
        function showViz(type) {
            // Update controls
            document.querySelectorAll('.viz-control').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Render visualization
            renderVisualization(type);
        }

        function renderVisualization(type) {
            const container = document.getElementById('vizContainer');
            container.innerHTML = '<div class="spinner"></div>';

            setTimeout(() => {
                if (type === 'scatter') {
                    renderScatterPlot(container);
                } else if (type === 'hierarchy') {
                    renderHierarchy(container);
                } else if (type === 'timeline') {
                    renderTimeline(container);
                } else if (type === 'heatmap') {
                    renderHeatmap(container);
                }
            }, 500);
        }

        function renderScatterPlot(container) {
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = 400;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Generate random points for demo
            const data = Array.from({length: 50}, () => ({
                x: Math.random() * width,
                y: Math.random() * height,
                cluster: Math.floor(Math.random() * 4)
            }));

            const colors = ['#4f46e5', '#06b6d4', '#10b981', '#f59e0b'];

            svg.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('r', 6)
                .attr('fill', d => colors[d.cluster])
                .attr('opacity', 0.7)
                .on('mouseover', function() {
                    d3.select(this).attr('r', 8).attr('opacity', 1);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 6).attr('opacity', 0.7);
                });
        }

        function renderHierarchy(container) {
            container.innerHTML = '';
            
            if (!currentData || !currentData.clusters) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem;">No data available for hierarchy visualization</p>';
                return;
            }
            
            const width = container.clientWidth;
            const height = 400;
            const margin = {top: 20, right: 90, bottom: 30, left: 90};
            
            // Create hierarchical data structure
            const hierarchyData = {
                name: "All Conversations",
                children: currentData.clusters.map(cluster => ({
                    name: cluster.name,
                    value: cluster.count,
                    description: cluster.description
                }))
            };
            
            const root = d3.hierarchy(hierarchyData)
                .sum(d => d.value || 0)
                .sort((a, b) => b.value - a.value);
            
            const treeLayout = d3.tree()
                .size([height - margin.top - margin.bottom, width - margin.left - margin.right]);
            
            treeLayout(root);
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Draw links
            g.selectAll('.link')
                .data(root.links())
                .enter().append('path')
                .attr('class', 'link')
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x))
                .style('fill', 'none')
                .style('stroke', '#ccc')
                .style('stroke-width', 2);
            
            // Draw nodes
            const node = g.selectAll('.node')
                .data(root.descendants())
                .enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.y},${d.x})`);
            
            node.append('circle')
                .attr('r', d => d.children ? 6 : 4)
                .style('fill', d => d.children ? '#4f46e5' : '#06b6d4')
                .style('stroke', '#fff')
                .style('stroke-width', 2);
            
            node.append('text')
                .attr('dy', '.35em')
                .attr('x', d => d.children ? -10 : 10)
                .style('text-anchor', d => d.children ? 'end' : 'start')
                .style('font-size', '12px')
                .text(d => d.data.name + (d.data.value ? ` (${d.data.value})` : ''));
            
            // Add hover effects
            node.on('mouseover', function(event, d) {
                d3.select(this).select('circle')
                    .transition()
                    .duration(200)
                    .attr('r', d => d.children ? 8 : 6);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).select('circle')
                    .transition()
                    .duration(200)
                    .attr('r', d => d.children ? 6 : 4);
            });
        }

        function renderTimeline(container) {
            container.innerHTML = '';
            
            if (!currentData || !currentData.conversations) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem;">No data available for timeline visualization</p>';
                return;
            }
            
            const width = container.clientWidth;
            const height = 400;
            const margin = {top: 20, right: 30, bottom: 40, left: 50};
            
            // Generate timeline data (simulating timestamps)
            const timelineData = currentData.conversations.map((conv, i) => {
                const baseTime = new Date();
                baseTime.setHours(baseTime.getHours() - (currentData.conversations.length - i) * 2);
                return {
                    time: baseTime,
                    value: conv.sentiment || Math.random(),
                    text: conv.text,
                    category: conv.category
                };
            });
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(timelineData, d => d.time))
                .range([0, width - margin.left - margin.right]);
            
            const yScale = d3.scaleLinear()
                .domain([-1, 1])
                .range([height - margin.top - margin.bottom, 0]);
            
            // Create line generator
            const line = d3.line()
                .x(d => xScale(d.time))
                .y(d => yScale(d.value))
                .curve(d3.curveMonotoneX);
            
            // Add X axis
            g.append('g')
                .attr('transform', `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(xScale)
                    .tickFormat(d3.timeFormat('%H:%M')));
            
            // Add Y axis
            g.append('g')
                .call(d3.axisLeft(yScale)
                    .tickValues([-1, -0.5, 0, 0.5, 1])
                    .tickFormat(d => d === 0 ? 'Neutral' : d > 0 ? 'Positive' : 'Negative'));
            
            // Add the line
            g.append('path')
                .datum(timelineData)
                .attr('fill', 'none')
                .attr('stroke', '#4f46e5')
                .attr('stroke-width', 2)
                .attr('d', line);
            
            // Add dots for each data point
            g.selectAll('.dot')
                .data(timelineData)
                .enter().append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.time))
                .attr('cy', d => yScale(d.value))
                .attr('r', 4)
                .attr('fill', d => d.value > 0 ? '#10b981' : d.value < 0 ? '#ef4444' : '#6b7280')
                .on('mouseover', function(event, d) {
                    // Show tooltip
                    const tooltip = d3.select('body').append('div')
                        .attr('class', 'tooltip')
                        .style('position', 'absolute')
                        .style('background', 'rgba(0,0,0,0.8)')
                        .style('color', 'white')
                        .style('padding', '8px')
                        .style('border-radius', '4px')
                        .style('font-size', '12px')
                        .style('pointer-events', 'none')
                        .style('opacity', 0);
                    
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    
                    tooltip.html(`${d.category || 'General'}<br/>Sentiment: ${d.value.toFixed(2)}`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.selectAll('.tooltip').remove();
                });
            
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Sentiment Timeline');
        }

        function renderHeatmap(container) {
            container.innerHTML = '';
            
            if (!currentData || !currentData.clusters) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem;">No data available for heatmap visualization</p>';
                return;
            }
            
            const width = container.clientWidth;
            const height = 400;
            const margin = {top: 50, right: 50, bottom: 50, left: 100};
            
            // Create similarity matrix data
            const categories = currentData.clusters.map(c => c.name);
            const matrixData = [];
            
            categories.forEach((cat1, i) => {
                categories.forEach((cat2, j) => {
                    // Generate similarity scores (in real app, this would come from backend)
                    const similarity = i === j ? 1 : Math.random() * 0.8;
                    matrixData.push({
                        x: cat2,
                        y: cat1,
                        value: similarity
                    });
                });
            });
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create scales
            const xScale = d3.scaleBand()
                .domain(categories)
                .range([0, width - margin.left - margin.right])
                .padding(0.05);
            
            const yScale = d3.scaleBand()
                .domain(categories)
                .range([0, height - margin.top - margin.bottom])
                .padding(0.05);
            
            const colorScale = d3.scaleSequential()
                .domain([0, 1])
                .interpolator(d3.interpolateBlues);
            
            // Add X axis
            g.append('g')
                .attr('transform', `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');
            
            // Add Y axis
            g.append('g')
                .call(d3.axisLeft(yScale));
            
            // Add heatmap cells
            g.selectAll('.cell')
                .data(matrixData)
                .enter().append('rect')
                .attr('x', d => xScale(d.x))
                .attr('y', d => yScale(d.y))
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .style('fill', d => colorScale(d.value))
                .style('stroke', 'white')
                .style('stroke-width', 1)
                .on('mouseover', function(event, d) {
                    // Show tooltip
                    const tooltip = d3.select('body').append('div')
                        .attr('class', 'tooltip')
                        .style('position', 'absolute')
                        .style('background', 'rgba(0,0,0,0.8)')
                        .style('color', 'white')
                        .style('padding', '8px')
                        .style('border-radius', '4px')
                        .style('font-size', '12px')
                        .style('pointer-events', 'none')
                        .style('opacity', 0);
                    
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    
                    tooltip.html(`${d.y} ‚Üî ${d.x}<br/>Similarity: ${(d.value * 100).toFixed(0)}%`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.selectAll('.tooltip').remove();
                });
            
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Cluster Similarity Heatmap');
            
            // Add color legend
            const legendWidth = 200;
            const legendHeight = 20;
            
            const legendScale = d3.scaleLinear()
                .domain([0, 1])
                .range([0, legendWidth]);
            
            const legendAxis = d3.axisBottom(legendScale)
                .ticks(5)
                .tickFormat(d => `${(d * 100).toFixed(0)}%`);
            
            const legend = svg.append('g')
                .attr('transform', `translate(${width - margin.right - legendWidth - 20}, 20)`);
            
            // Create gradient for legend
            const gradientId = 'heatmap-gradient';
            const gradient = svg.append('defs')
                .append('linearGradient')
                .attr('id', gradientId)
                .attr('x1', '0%')
                .attr('x2', '100%')
                .attr('y1', '0%')
                .attr('y2', '0%');
            
            for (let i = 0; i <= 10; i++) {
                gradient.append('stop')
                    .attr('offset', `${i * 10}%`)
                    .attr('stop-color', colorScale(i / 10));
            }
            
            legend.append('rect')
                .attr('width', legendWidth)
                .attr('height', legendHeight)
                .style('fill', `url(#${gradientId})`);
            
            legend.append('g')
                .attr('transform', `translate(0, ${legendHeight})`)
                .call(legendAxis);
        }

        // Patterns View
        function renderPatterns() {
            const content = document.getElementById('patternsContent');
            
            if (!currentData || !currentData.clusters) {
                content.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">No pattern data available. Please analyze conversations first.</p>';
                return;
            }
            
            // Extract patterns from clusters
            const topics = {};
            const sentiments = { positive: 0, neutral: 0, negative: 0 };
            const keywords = {};
            
            // Process clusters to find patterns
            currentData.clusters.forEach(cluster => {
                topics[cluster.name] = cluster.count;
            });
            
            // Process conversations for sentiment and keywords
            if (currentData.conversations) {
                currentData.conversations.forEach(conv => {
                    // Analyze sentiment
                    const sentiment = conv.sentiment || 0;
                    if (sentiment > 0.3) sentiments.positive++;
                    else if (sentiment < -0.3) sentiments.negative++;
                    else sentiments.neutral++;
                    
                    // Extract keywords (simple word frequency)
                    const words = (conv.text || '').toLowerCase().split(/\s+/);
                    words.forEach(word => {
                        if (word.length > 4) { // Only count words longer than 4 chars
                            keywords[word] = (keywords[word] || 0) + 1;
                        }
                    });
                });
            }
            
            // Sort topics by count
            const sortedTopics = Object.entries(topics)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            // Sort keywords by frequency
            const topKeywords = Object.entries(keywords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Calculate percentages
            const total = currentData.conversations?.length || 1;
            const totalTopics = Object.values(topics).reduce((a, b) => a + b, 0) || 1;
            
            content.innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <div class="metric-card">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Discovered Topics</h4>
                        <ul style="margin-top: 0.5rem; list-style: none;">
                            ${sortedTopics.map(([topic, count]) => `
                                <li style="margin-bottom: 0.5rem; display: flex; align-items: center;">
                                    <span style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-right: 0.5rem;"></span>
                                    <span style="flex: 1;">${topic}</span>
                                    <span style="color: var(--gray);">${((count / totalTopics) * 100).toFixed(0)}%</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="metric-card">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Sentiment Analysis</h4>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üòä Positive</span>
                                <span>${((sentiments.positive / total) * 100).toFixed(0)}%</span>
                            </div>
                            <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #10b981; height: 100%; width: ${(sentiments.positive / total) * 100}%;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üòê Neutral</span>
                                <span>${((sentiments.neutral / total) * 100).toFixed(0)}%</span>
                            </div>
                            <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #6b7280; height: 100%; width: ${(sentiments.neutral / total) * 100}%;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üòü Negative</span>
                                <span>${((sentiments.negative / total) * 100).toFixed(0)}%</span>
                            </div>
                            <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #ef4444; height: 100%; width: ${(sentiments.negative / total) * 100}%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Top Keywords</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${topKeywords.map(([word, count]) => `
                                <span style="padding: 0.25rem 0.75rem; background: var(--light); border-radius: 1rem; font-size: 0.85rem;">
                                    ${word} <span style="color: var(--gray);">(${count})</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Pattern Insights</h4>
                        <ul style="list-style: none; line-height: 1.8;">
                            <li>üìä <strong>${sortedTopics.length}</strong> distinct conversation patterns identified</li>
                            <li>üîÑ <strong>${((sentiments.positive / total) * 100).toFixed(0)}%</strong> positive sentiment overall</li>
                            <li>üìà Most common topic: <strong>${sortedTopics[0] ? sortedTopics[0][0] : 'N/A'}</strong></li>
                            <li>üîë Top keyword: <strong>${topKeywords[0] ? topKeywords[0][0] : 'N/A'}</strong></li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Insights View
        function renderInsights() {
            const content = document.getElementById('insightsContent');
            
            if (!currentData || !currentData.clusters) {
                content.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">No insights available. Please analyze conversations first.</p>';
                return;
            }
            
            // Generate insights from data
            const insights = [];
            const total = currentData.conversations?.length || 0;
            
            // Analyze clusters for insights
            if (currentData.clusters && currentData.clusters.length > 0) {
                // Find largest cluster
                const largestCluster = currentData.clusters.reduce((prev, current) => 
                    (prev.count > current.count) ? prev : current
                );
                
                insights.push({
                    title: 'Dominant Pattern',
                    description: `The largest conversation cluster is "${largestCluster.name}" with ${largestCluster.count} conversations (${((largestCluster.count / total) * 100).toFixed(0)}% of total)`,
                    type: 'pattern',
                    icon: 'üéØ'
                });
                
                // Cluster distribution insight
                const avgClusterSize = currentData.clusters.reduce((sum, c) => sum + c.count, 0) / currentData.clusters.length;
                insights.push({
                    title: 'Conversation Distribution',
                    description: `Conversations are grouped into ${currentData.clusters.length} distinct patterns with an average of ${avgClusterSize.toFixed(0)} conversations per cluster`,
                    type: 'distribution',
                    icon: 'üìä'
                });
            }
            
            // Analyze sentiment trends
            if (currentData.conversations) {
                const sentiments = currentData.conversations.map(c => c.sentiment || 0);
                const avgSentiment = sentiments.reduce((a, b) => a + b, 0) / sentiments.length;
                const positivePct = (sentiments.filter(s => s > 0.3).length / sentiments.length * 100).toFixed(0);
                
                insights.push({
                    title: 'Sentiment Overview',
                    description: `Overall sentiment is ${avgSentiment > 0 ? 'positive' : avgSentiment < 0 ? 'negative' : 'neutral'} with ${positivePct}% positive conversations`,
                    type: 'sentiment',
                    icon: avgSentiment > 0 ? 'üòä' : avgSentiment < 0 ? 'üòü' : 'üòê'
                });
                
                // Find outliers
                const outliers = sentiments.filter(s => Math.abs(s) > 0.8).length;
                if (outliers > 0) {
                    insights.push({
                        title: 'Strong Reactions',
                        description: `${outliers} conversations (${((outliers / total) * 100).toFixed(0)}%) show strong emotional responses that may require attention`,
                        type: 'alert',
                        icon: '‚ö°'
                    });
                }
            }
            
            // Category-based insights
            if (currentData.conversations) {
                const categories = {};
                currentData.conversations.forEach(conv => {
                    const cat = conv.category || 'Uncategorized';
                    categories[cat] = (categories[cat] || 0) + 1;
                });
                
                const topCategory = Object.entries(categories)
                    .sort((a, b) => b[1] - a[1])[0];
                
                if (topCategory) {
                    insights.push({
                        title: 'Primary Focus Area',
                        description: `"${topCategory[0]}" is the most frequent conversation type, appearing in ${topCategory[1]} conversations`,
                        type: 'category',
                        icon: 'üîç'
                    });
                }
            }
            
            // Actionable recommendations
            const recommendations = [];
            
            if (insights.find(i => i.type === 'sentiment' && i.description.includes('negative'))) {
                recommendations.push({
                    title: 'Improve Sentiment',
                    action: 'Focus on addressing negative feedback patterns to improve overall satisfaction',
                    priority: 'high'
                });
            }
            
            if (currentData.clusters && currentData.clusters.length > 10) {
                recommendations.push({
                    title: 'Simplify Patterns',
                    action: 'Consider consolidating similar conversation patterns for better management',
                    priority: 'medium'
                });
            }
            
            if (insights.find(i => i.type === 'alert')) {
                recommendations.push({
                    title: 'Address Outliers',
                    action: 'Review conversations with extreme sentiment scores for immediate action items',
                    priority: 'high'
                });
            }
            
            content.innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">Key Insights</h3>
                        <div style="display: grid; gap: 1rem;">
                            ${insights.map(insight => `
                                <div class="metric-card" style="border-left: 4px solid ${insight.type === 'alert' ? 'var(--warning)' : 'var(--primary)'};">
                                    <h4 style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.5rem;">${insight.icon}</span>
                                        ${insight.title}
                                    </h4>
                                    <p style="margin-top: 0.5rem; line-height: 1.6;">${insight.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${recommendations.length > 0 ? `
                        <div>
                            <h3 style="margin-bottom: 1rem; color: var(--primary);">Recommendations</h3>
                            <div style="display: grid; gap: 1rem;">
                                ${recommendations.map(rec => `
                                    <div class="metric-card" style="border-left: 4px solid ${rec.priority === 'high' ? 'var(--danger)' : 'var(--warning)'};">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <h4>${rec.title}</h4>
                                            <span style="padding: 0.25rem 0.5rem; background: ${rec.priority === 'high' ? 'var(--danger)' : 'var(--warning)'}; color: white; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase;">
                                                ${rec.priority}
                                            </span>
                                        </div>
                                        <p style="margin-top: 0.5rem; line-height: 1.6;">${rec.action}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="metric-card" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                        <h4 style="color: white;">Analysis Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div style="font-size: 2rem; font-weight: bold;">${currentData.conversations?.length || 0}</div>
                                <div style="opacity: 0.9;">Total Conversations</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: bold;">${currentData.clusters?.length || 0}</div>
                                <div style="opacity: 0.9;">Patterns Found</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: bold;">${insights.length}</div>
                                <div style="opacity: 0.9;">Key Insights</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Paste Data
        function showPasteDialog() {
            document.getElementById('pasteModal').classList.add('active');
        }

        async function processPastedData() {
            const input = document.getElementById('pasteInput').value;
            if (!input.trim()) return;

            try {
                const data = JSON.parse(input);
                currentData = data;
                closeModal('pasteModal');
                await startAnalysis(data);
            } catch (error) {
                alert('Invalid JSON format. Please check your data and try again.');
            }
        }

        // Settings
        function saveSettings() {
            const settings = {
                provider: document.getElementById('providerSelect').value,
                model: document.getElementById('modelInput').value,
                batchSize: document.getElementById('batchSizeInput').value
            };
            
            localStorage.setItem('briefx-settings', JSON.stringify(settings));
            alert('Settings saved successfully!');
        }

        // Progress Management
        function showProgress(text) {
            const container = document.getElementById('progressContainer');
            container.classList.add('active');
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            if (text) {
                document.getElementById('progressText').textContent = text;
            }
        }

        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('active');
        }

        // Modal Management
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Recent Projects
        function loadRecentProjects() {
            const container = document.getElementById('recentProjects');
            const projects = JSON.parse(localStorage.getItem('briefx-projects') || '[]');
            
            if (projects.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No recent projects</p>';
                return;
            }

            projects.slice(0, 3).forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'upload-card';
                projectCard.style.cssText = 'cursor: pointer; padding: 1rem;';
                projectCard.innerHTML = `
                    <h4>${project.name}</h4>
                    <p style="font-size: 0.85rem; color: var(--gray);">${project.date}</p>
                `;
                projectCard.addEventListener('click', () => loadProject(project));
                container.appendChild(projectCard);
            });
        }

        function loadProject(project) {
            currentData = project.data;
            switchView('analysis');
            renderAnalysis();
        }

        function newProject() {
            currentData = null;
            selectedCluster = null;
            switchView('upload');
        }

        function showHelp() {
            alert('BriefX Help\n\n1. Upload your conversation data\n2. Wait for analysis to complete\n3. Explore clusters and patterns\n4. Export insights for action');
        }

        // =============================================================================
        // Clio Methodology Functions
        // =============================================================================
        
        // Global variables for Clio
        let currentClioAnalysisId = null;
        let clioPollingInterval = null;

        // Load default privacy configuration
        async function loadPrivacyConfig() {
            try {
                const response = await fetch('/api/clio/privacy/config');
                const result = await response.json();
                
                if (result.success) {
                    const config = result.data;
                    document.getElementById('kAnonymity').value = config.k_anonymity;
                    document.getElementById('privacyLevel').value = config.privacy_level;
                    document.getElementById('removePII').checked = config.remove_pii;
                    document.getElementById('redactSensitive').checked = config.redact_sensitive;
                    document.getElementById('minClusterSize').value = config.min_cluster_size;
                    
                    alert('Privacy configuration loaded successfully!');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading privacy config:', error);
                alert('Failed to load privacy configuration: ' + error.message);
            }
        }

        // Start Clio analysis
        async function startClioAnalysis() {
            if (!currentData || !currentData.conversations) {
                alert('Please upload conversation data first from the Upload tab.');
                return;
            }

            const button = document.getElementById('clioAnalyzeBtn');
            const originalText = button.textContent;
            button.textContent = 'Starting Analysis...';
            button.disabled = true;

            try {
                // Collect configuration
                const config = {
                    conversations: currentData.conversations,
                    k_anonymity: parseInt(document.getElementById('kAnonymity').value),
                    privacy_level: document.getElementById('privacyLevel').value,
                    remove_pii: document.getElementById('removePII').checked,
                    redact_sensitive: document.getElementById('redactSensitive').checked,
                    clustering_algorithm: document.getElementById('clusteringAlgorithm').value,
                    min_cluster_size: parseInt(document.getElementById('minClusterSize').value),
                    max_hierarchy_depth: parseInt(document.getElementById('maxHierarchyDepth').value),
                    pattern_threshold: parseFloat(document.getElementById('patternThreshold').value)
                };

                // Start analysis
                const response = await fetch('/api/clio/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.status === 'started') {
                    currentClioAnalysisId = result.analysis_id;
                    
                    // Show results panel and start polling
                    document.getElementById('clioResults').style.display = 'block';
                    startClioPolling();
                    
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('Error starting Clio analysis:', error);
                alert('Failed to start Clio analysis: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Poll for Clio analysis status
        function startClioPolling() {
            if (clioPollingInterval) {
                clearInterval(clioPollingInterval);
            }

            clioPollingInterval = setInterval(async () => {
                await pollClioStatus();
            }, 2000); // Poll every 2 seconds

            // Initial poll
            pollClioStatus();
        }

        // Poll Clio status
        async function pollClioStatus() {
            if (!currentClioAnalysisId) return;

            try {
                const response = await fetch(`/api/clio/status/${currentClioAnalysisId}`);
                const status = await response.json();

                updateClioStatusDisplay(status);

                if (status.status === 'completed') {
                    clearInterval(clioPollingInterval);
                    await loadClioResults();
                } else if (status.status === 'failed') {
                    clearInterval(clioPollingInterval);
                    document.getElementById('clioStatusContent').innerHTML = 
                        `<div style="color: var(--danger); text-align: center; padding: 2rem;">
                            <p>‚ùå Analysis failed: ${status.message}</p>
                        </div>`;
                }

            } catch (error) {
                console.error('Error polling Clio status:', error);
            }
        }

        // Update status display
        function updateClioStatusDisplay(status) {
            const statusContent = document.getElementById('clioStatusContent');
            
            if (status.status === 'in_progress') {
                statusContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        <p style="margin-top: 1rem;">${status.message}</p>
                        <div style="background: #f3f4f6; border-radius: 0.5rem; height: 8px; margin-top: 1rem;">
                            <div style="background: var(--primary); height: 100%; border-radius: 0.5rem; width: ${status.progress}%; transition: width 0.3s;"></div>
                        </div>
                        <small style="color: var(--gray);">${status.progress}% complete</small>
                    </div>
                `;
            } else if (status.status === 'completed') {
                statusContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--success);">
                        <p>‚úÖ Clio analysis completed successfully!</p>
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;">
                            <div>
                                <strong>${status.total_clusters}</strong><br>
                                <small>Clusters</small>
                            </div>
                            <div>
                                <strong>${status.total_patterns}</strong><br>
                                <small>Patterns</small>
                            </div>
                            <div>
                                <strong>${status.hierarchy_depth}</strong><br>
                                <small>Hierarchy Depth</small>
                            </div>
                            <div>
                                <strong>$${status.analysis_cost}</strong><br>
                                <small>Analysis Cost</small>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Load Clio results
        async function loadClioResults() {
            try {
                // Load privacy audit
                await loadPrivacyAudit();
                
                // Load hierarchy
                await loadClioHierarchy();
                
                // Load patterns
                await loadClioPatterns();
                
                // Load investigation tools
                await loadInvestigationTools();
                
            } catch (error) {
                console.error('Error loading Clio results:', error);
            }
        }

        // Load privacy audit results
        async function loadPrivacyAudit() {
            try {
                const response = await fetch(`/api/clio/privacy/audit/${currentClioAnalysisId}`);
                const audit = await response.json();

                if (response.ok) {
                    document.getElementById('privacyAudit').style.display = 'block';
                    
                    const auditContent = document.getElementById('privacyAuditContent');
                    const score = audit.compliance_score;
                    const scoreClass = score >= 0.8 ? 'high' : score >= 0.6 ? 'medium' : 'low';
                    
                    auditContent.innerHTML = `
                        <div style="margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span>Overall Compliance Score</span>
                                <span class="privacy-score ${scoreClass}">${Math.round(score * 100)}%</span>
                            </div>
                            <div style="background: #f3f4f6; border-radius: 0.5rem; height: 12px;">
                                <div style="background: ${score >= 0.8 ? 'var(--success)' : score >= 0.6 ? 'var(--warning)' : 'var(--danger)'}; height: 100%; border-radius: 0.5rem; width: ${score * 100}%;"></div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                                <h4 style="margin-bottom: 0.5rem;">PII Detection</h4>
                                <p>Redacted: ${audit.detailed_findings.pii_detection.redacted_conversations || 0} conversations</p>
                                <p>Rate: ${Math.round((audit.detailed_findings.pii_detection.redaction_rate || 0) * 100)}%</p>
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                                <h4 style="margin-bottom: 0.5rem;">K-Anonymity</h4>
                                <p>Groups: ${audit.detailed_findings.anonymity_compliance.total_anonymity_groups || 0}</p>
                                <p>Compliant: ${Math.round((audit.detailed_findings.anonymity_compliance.compliance_rate || 0) * 100)}%</p>
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                                <h4 style="margin-bottom: 0.5rem;">Cluster Size</h4>
                                <p>Total: ${audit.detailed_findings.cluster_size_compliance.total_clusters || 0} clusters</p>
                                <p>Small: ${audit.detailed_findings.cluster_size_compliance.small_clusters || 0}</p>
                            </div>
                        </div>

                        <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 0.5rem; padding: 1rem;">
                            <h4 style="margin-bottom: 0.5rem; color: #d97706;">Recommendations</h4>
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                ${audit.improvement_suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading privacy audit:', error);
            }
        }

        // Load Clio hierarchy
        async function loadClioHierarchy() {
            try {
                const response = await fetch(`/api/clio/hierarchy/${currentClioAnalysisId}`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('clioHierarchy').style.display = 'block';
                    
                    // Simple hierarchy display (could be enhanced with D3.js)
                    const hierarchyContent = document.getElementById('hierarchyVisualization');
                    hierarchyContent.innerHTML = `
                        <div style="background: #f8fafc; padding: 2rem; border-radius: 0.5rem; text-align: center;">
                            <h4>Hierarchy Overview</h4>
                            <div style="margin: 2rem 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                <div>
                                    <strong>${data.hierarchy.total_nodes}</strong><br>
                                    <small>Total Nodes</small>
                                </div>
                                <div>
                                    <strong>${data.hierarchy.depth}</strong><br>
                                    <small>Max Depth</small>
                                </div>
                                <div>
                                    <strong>${data.clusters.length}</strong><br>
                                    <small>Leaf Clusters</small>
                                </div>
                                <div>
                                    <strong>${data.conversations}</strong><br>
                                    <small>Conversations</small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <h4 style="margin-bottom: 1rem;">Cluster Details</h4>
                            <div style="display: grid; gap: 1rem;">
                                ${data.clusters.map(cluster => `
                                    <div class="clio-search-result">
                                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                                            <h5 style="margin: 0;">${cluster.name}</h5>
                                            <span class="privacy-score ${cluster.privacy_level === 'high' ? 'high' : 'medium'}">${cluster.privacy_level}</span>
                                        </div>
                                        <p style="margin: 0.5rem 0; color: var(--gray);">${cluster.summary}</p>
                                        <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--gray);">
                                            <span>Size: ${cluster.size}</span>
                                            <span>Keywords: ${cluster.keywords.slice(0, 3).join(', ')}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading Clio hierarchy:', error);
            }
        }

        // Load Clio patterns
        async function loadClioPatterns() {
            try {
                const response = await fetch(`/api/clio/patterns/${currentClioAnalysisId}`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('clioPatterns').style.display = 'block';
                    
                    const patternsGrid = document.getElementById('patternsGrid');
                    patternsGrid.innerHTML = data.patterns.map(pattern => `
                        <div class="clio-pattern-card">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
                                <h4 style="margin: 0;">${pattern.name}</h4>
                                <span class="privacy-score ${pattern.privacy_score >= 0.8 ? 'high' : pattern.privacy_score >= 0.6 ? 'medium' : 'low'}">
                                    Privacy: ${Math.round(pattern.privacy_score * 100)}%
                                </span>
                            </div>
                            <p style="margin-bottom: 1rem; color: var(--gray);">${pattern.description}</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <strong>Support:</strong> ${Math.round(pattern.support * 100)}%
                                </div>
                                <div>
                                    <strong>Confidence:</strong> ${Math.round(pattern.confidence * 100)}%
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Keywords:</strong>
                                <div style="margin-top: 0.5rem;">
                                    ${pattern.keywords.map(keyword => 
                                        `<span style="background: #e0e7ff; color: var(--primary); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-right: 0.5rem;">${keyword}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            <div style="font-size: 0.875rem; color: var(--gray);">
                                Appears in ${pattern.cluster_ids.length} cluster${pattern.cluster_ids.length !== 1 ? 's' : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading Clio patterns:', error);
            }
        }

        // Load investigation tools
        async function loadInvestigationTools() {
            document.getElementById('clioInvestigation').style.display = 'block';
            
            // Load investigation suggestions
            try {
                const response = await fetch('/api/clio/investigate/suggest');
                const data = await response.json();
                
                if (data.success) {
                    const suggestionButtons = document.getElementById('suggestionButtons');
                    suggestionButtons.innerHTML = data.data.map(suggestion => `
                        <button class="btn btn-secondary" onclick="quickInvestigation('${suggestion}')" 
                                style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                            ${suggestion}
                        </button>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading investigation suggestions:', error);
            }
        }

        // Search Clio clusters
        async function searchClioClusters() {
            const query = document.getElementById('clioSearchQuery').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            try {
                const response = await fetch(`/api/clio/search/${currentClioAnalysisId}?query=${encodeURIComponent(query)}&limit=10`);
                const results = await response.json();

                if (response.ok) {
                    displaySearchResults(results);
                } else {
                    throw new Error(results.error);
                }
            } catch (error) {
                console.error('Error searching clusters:', error);
                alert('Search failed: ' + error.message);
            }
        }

        // Display search results
        function displaySearchResults(results) {
            const searchResultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                searchResultsDiv.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No clusters found matching your query.</p>';
                return;
            }

            searchResultsDiv.innerHTML = `
                <h4 style="margin-bottom: 1rem;">Search Results (${results.length})</h4>
                ${results.map(result => `
                    <div class="clio-search-result">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <h5 style="margin: 0;">${result.cluster_name}</h5>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="background: #e0e7ff; color: var(--primary); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                    ${Math.round(result.relevance * 100)}% match
                                </span>
                                <span style="color: var(--gray); font-size: 0.875rem;">${result.size} conversations</span>
                            </div>
                        </div>
                        <p style="margin: 0; color: var(--gray);">${result.summary}</p>
                        <button class="btn btn-primary" onclick="investigateCluster('${result.cluster_id}')" 
                                style="margin-top: 1rem; font-size: 0.875rem;">
                            Investigate Cluster
                        </button>
                    </div>
                `).join('')}
            `;
        }

        // Quick investigation
        function quickInvestigation(suggestion) {
            document.getElementById('clioSearchQuery').value = suggestion;
            searchClioClusters();
        }

        // Investigate specific cluster
        async function investigateCluster(clusterId) {
            try {
                const response = await fetch(`/api/clio/investigate/${currentClioAnalysisId}/${clusterId}`, {
                    method: 'POST'
                });
                const investigation = await response.json();

                if (response.ok) {
                    displayInvestigationResults(investigation);
                } else {
                    throw new Error(investigation.error);
                }
            } catch (error) {
                console.error('Error investigating cluster:', error);
                alert('Investigation failed: ' + error.message);
            }
        }

        // Display investigation results
        function displayInvestigationResults(investigation) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 1000; 
                display: flex; align-items: center; justify-content: center;
                padding: 2rem;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                        <h3 style="margin: 0;">üîç Cluster Investigation: ${investigation.cluster.name}</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                        <p style="margin: 0; margin-bottom: 1rem;">${investigation.cluster.summary}</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center;">
                            <div><strong>${investigation.statistics.total_conversations}</strong><br><small>Conversations</small></div>
                            <div><strong>${investigation.cluster.privacy_level}</strong><br><small>Privacy Level</small></div>
                            <div><strong>${investigation.statistics.keywords.length}</strong><br><small>Keywords</small></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;">Sample Conversations</h4>
                        ${investigation.sample_conversations.map((conv, i) => `
                            <div style="background: #fff; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <div style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">
                                    Conversation ${i + 1} ‚Ä¢ Privacy: ${conv.privacy_level}
                                </div>
                                <p style="margin: 0;">${conv.content}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;">Related Patterns (${investigation.related_patterns.length})</h4>
                        ${investigation.related_patterns.length > 0 ? 
                            investigation.related_patterns.map(pattern => `
                                <div style="background: #f0f7ff; border: 1px solid #bfdbfe; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                    <h5 style="margin: 0 0 0.5rem 0;">${pattern.name}</h5>
                                    <p style="margin: 0 0 0.5rem 0; color: var(--gray);">${pattern.description}</p>
                                    <div style="font-size: 0.875rem;">
                                        Confidence: <strong>${Math.round(pattern.confidence * 100)}%</strong> ‚Ä¢ 
                                        Keywords: ${pattern.keywords.slice(0, 3).join(', ')}
                                    </div>
                                </div>
                            `).join('') : 
                            '<p style="color: var(--gray);">No related patterns found.</p>'
                        }
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 1rem;">Recommendations</h4>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            ${investigation.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Utility Functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>