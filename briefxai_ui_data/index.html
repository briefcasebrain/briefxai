<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BriefX - Conversation Analysis Platform</title>
    <link rel="stylesheet" href="static/style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active">
            <div class="welcome-container">
                <h1>BriefX</h1>
                <p class="subtitle">Advanced Conversation Analysis Platform</p>
                <p style="color: #6b7280; margin-top: 10px; font-size: 14px;">Upload ‚Üí Process ‚Üí Analyze ‚Üí Dashboard</p>
                
                <div class="quick-start">
                    <h2>Choose Your Data Source</h2>
                    <div class="option-cards">
                        <div class="card" onclick="showUploadScreen()">
                            <div class="icon" style="font-size: 32px; color: #3b82f6;">‚¨Ü</div>
                            <h3>Upload Files</h3>
                            <p><strong>Structured:</strong> JSON, CSV, Parquet</p>
                            <p style="font-size: 12px; color: #9ca3af; margin-top: 5px;"><strong>Unstructured:</strong> PDF, TXT, DOCX</p>
                            <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; position: absolute; top: 10px; right: 10px;">OCR Support</span>
                        </div>
                        
                        <div class="card" onclick="useExampleData()">
                            <div class="icon" style="font-size: 32px; color: #10b981;">‚óâ</div>
                            <h3>Use Example Data</h3>
                            <p>Try with pre-generated sample conversations</p>
                            <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; position: absolute; top: 10px; right: 10px;">Quick Start</span>
                        </div>
                        
                        <div class="card" onclick="pasteData()">
                            <div class="icon" style="font-size: 32px; color: #6366f1;">‚ñ§</div>
                            <h3>Paste Data</h3>
                            <p>Paste conversation data directly</p>
                            <p style="font-size: 12px; color: #9ca3af; margin-top: 5px;">JSON or plain text format</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Screen -->
        <div id="upload-screen" class="screen">
            <div class="upload-container">
                <button class="back-btn" onclick="showWelcomeScreen()">‚Üê Back</button>
                <h2>Upload Conversations</h2>
                
                <div class="drop-zone" id="drop-zone">
                    <div class="drop-content">
                        <div class="icon">üì§</div>
                        <p>Drag & drop your files here</p>
                        <p class="small" style="color: #6b7280; font-size: 12px;">Supported: JSON, CSV, Parquet, PDF, TXT, DOCX</p>
                        <button class="btn-primary" onclick="document.getElementById('file-input').click()">
                            Browse Files
                        </button>
                        <input type="file" id="file-input" accept=".json,.parquet,.csv,.pdf,.txt,.docx" multiple hidden>
                    </div>
                </div>
                
                <!-- OCR Processing Status -->
                <div id="ocr-status" style="display: none; margin: 20px 0; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="margin: 0; color: #92400e;">Text Extraction in Progress</h4>
                    <p style="margin: 5px 0; color: #78350f;">Extracting text from documents...</p>
                    <div style="width: 100%; background: #fed7aa; border-radius: 4px; height: 8px; margin-top: 10px;">
                        <div id="ocr-progress-bar" style="width: 0%; background: #f97316; height: 100%; border-radius: 4px; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div id="file-list" class="file-list"></div>
                
                <button id="analyze-btn" class="btn-success" disabled onclick="startAnalysis()">
                    Proceed to Analysis ‚Üí
                </button>
            </div>
        </div>

        <!-- Configuration Screen -->
        <div id="config-screen" class="screen">
            <div class="config-container">
                <button class="back-btn" onclick="showUploadScreen()">‚Üê Back</button>
                <h2>Configuration</h2>
                
                <div class="config-section">
                    <h3>LLM Provider</h3>
                    <select id="llm-provider" onchange="updateLLMOptions()">
                        <option value="openai" selected>OpenAI</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="ollama">Ollama (Local)</option>
                        <option value="huggingface">HuggingFace</option>
                        <option value="vllm">vLLM (Local Server)</option>
                    </select>
                    
                    <div id="llm-options">
                        <label>Model:</label>
                        <select id="llm-model" class="model-dropdown" onchange="onModelChange()">
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                        <button type="button" class="auto-detect-btn" onclick="applyLLMAutoDetection()">
                            üéØ Auto-Detect
                        </button>
                        
                        <div id="api-key-section">
                            <label>API Key:</label>
                            <input type="password" id="api-key" placeholder="Your OpenAI API key">
                        </div>
                        
                        <div id="base-url-section" style="display:none;">
                            <label>Base URL:</label>
                            <input type="text" id="base-url" placeholder="http://localhost:8000">
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>Embedding Provider</h3>
                    <select id="embedding-provider" onchange="updateEmbeddingOptions()">
                        <option value="openai" selected>OpenAI</option>
                        <option value="google">Google</option>
                        <option value="sentence-transformers">Sentence Transformers (Local)</option>
                        <option value="huggingface">HuggingFace</option>
                        <option value="ollama">Ollama (Local)</option>
                    </select>
                    
                    <label>Model:</label>
                    <select id="embedding-model" class="model-dropdown">
                        <option value="text-embedding-3-small">text-embedding-3-small</option>
                        <option value="text-embedding-3-large">text-embedding-3-large</option>
                        <option value="text-embedding-ada-002">text-embedding-ada-002</option>
                    </select>
                    <button type="button" class="auto-detect-btn" onclick="applyAutoDetection()">
                        üéØ Auto-Detect
                    </button>
                    
                    <div id="embedding-api-key-section">
                        <label>API Key (if different from LLM):</label>
                        <input type="password" id="embedding-api-key" placeholder="Leave blank to use same as LLM">
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>Analysis Options</h3>
                    <label>
                        <input type="checkbox" id="dedup" checked> Deduplicate conversations
                    </label>
                    <label>
                        <input type="checkbox" id="verbose" checked> Show detailed progress
                    </label>
                    
                    <label>Batch Size:</label>
                    <input type="number" id="batch-size" value="100" min="1" max="1000">
                </div>
                
                <button class="btn-success" onclick="runAnalysis()">
                    Run Analysis
                </button>
            </div>
        </div>

        <!-- Progress Screen -->
        <div id="progress-screen" class="screen">
            <div class="progress-container">
                <h2>Analysis in Progress</h2>
                
                <!-- Current stage display -->
                <div class="current-stage-display">
                    <h3 id="current-stage-title">Initializing...</h3>
                    <p id="current-stage-detail" class="stage-detail"></p>
                </div>
                
                <div class="progress-steps">
                    <div class="step" id="step-validation">
                        <span class="status">‚è≥</span>
                        <div class="step-content">
                            <span class="step-title">Data Validation</span>
                            <span class="step-detail"></span>
                        </div>
                    </div>
                    <div class="step" id="step-dedup">
                        <span class="status">‚è≥</span>
                        <div class="step-content">
                            <span class="step-title">Deduplication</span>
                            <span class="step-detail"></span>
                        </div>
                    </div>
                    <div class="step" id="step-facets">
                        <span class="status">‚è≥</span>
                        <div class="step-content">
                            <span class="step-title">Facet Extraction</span>
                            <span class="step-detail"></span>
                        </div>
                    </div>
                    <div class="step" id="step-embeddings">
                        <span class="status">‚è≥</span>
                        <div class="step-content">
                            <span class="step-title">Embedding Generation</span>
                            <span class="step-detail"></span>
                        </div>
                    </div>
                    <div class="step" id="step-clustering">
                        <span class="status">‚è≥</span>
                        <div class="step-content">
                            <span class="step-title">Clustering</span>
                            <span class="step-detail"></span>
                        </div>
                    </div>
                    <div class="step" id="step-hierarchy">
                        <span class="status">‚è≥</span>
                        <div class="step-content">
                            <span class="step-title">Hierarchy Building</span>
                            <span class="step-detail"></span>
                        </div>
                    </div>
                    <div class="step" id="step-umap">
                        <span class="status">‚è≥</span>
                        <div class="step-content">
                            <span class="step-title">UMAP Visualization</span>
                            <span class="step-detail"></span>
                        </div>
                    </div>
                    <div class="step" id="step-finalize">
                        <span class="status">‚è≥</span>
                        <div class="step-content">
                            <span class="step-title">Finalizing</span>
                            <span class="step-detail"></span>
                        </div>
                    </div>
                </div>
                
                <div class="progress-bar-wrapper">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <span class="progress-percentage" id="progress-percentage">0%</span>
                </div>
                
                <div class="log-section">
                    <h4>Detailed Progress Log</h4>
                    <div id="progress-log" class="log-container"></div>
                </div>
            </div>
        </div>

        <!-- Unified Dashboard Screen -->
        <div id="results-screen" class="screen">
            <nav class="top-nav">
                <div class="nav-brand">BriefX Analysis Dashboard</div>
                <div class="nav-tabs">
                    <button class="tab active" onclick="showTab('overview')">Overview</button>
                    <button class="tab" onclick="showTab('hierarchy')">Clusters</button>
                    <button class="tab" onclick="showTab('umap')">Visualization</button>
                    <button class="tab" onclick="showTab('conversations')">Browse</button>
                    <button class="tab" onclick="showTab('insights')">Export</button>
                </div>
                <button class="btn-secondary" onclick="startNewAnalysis()">New Analysis</button>
            </nav>
            
            <div class="results-content">
                <!-- Overview Tab - Main Dashboard -->
                <div id="overview-tab" class="tab-content active">
                    <div style="padding: 20px;">
                        <!-- Key Metrics -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0; opacity: 0.9;">Total Conversations</h4>
                                <div style="font-size: 36px; font-weight: bold; margin: 10px 0;" id="total-conv-dashboard">0</div>
                                <p style="margin: 0; font-size: 14px; opacity: 0.8;">Successfully analyzed</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0; opacity: 0.9;">Clusters Found</h4>
                                <div style="font-size: 36px; font-weight: bold; margin: 10px 0;" id="total-clusters-dashboard">0</div>
                                <p style="margin: 0; font-size: 14px; opacity: 0.8;">Unique patterns</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0; opacity: 0.9;">Processing Time</h4>
                                <div style="font-size: 36px; font-weight: bold; margin: 10px 0;" id="process-time-dashboard">0s</div>
                                <p style="margin: 0; font-size: 14px; opacity: 0.8;">Total duration</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0; opacity: 0.9;">Accuracy</h4>
                                <div style="font-size: 36px; font-weight: bold; margin: 10px 0;" id="accuracy-dashboard">100%</div>
                                <p style="margin: 0; font-size: 14px; opacity: 0.8;">Data quality</p>
                            </div>
                        </div>
                        
                        <!-- Key Insights Section -->
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                            <h3 style="margin-top: 0;">Key Insights</h3>
                            <div id="insights-summary">
                                <p style="color: #6b7280;">Analysis results will appear here after processing...</p>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <h3 style="margin-top: 0;">Quick Actions</h3>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="showTab('hierarchy')" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    View Clusters
                                </button>
                                <button onclick="showTab('umap')" style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Explore Map
                                </button>
                                <button onclick="showTab('insights')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="hierarchy-tab" class="tab-content">
                    <div class="split-view">
                        <div class="tree-panel">
                            <h3>Cluster Hierarchy</h3>
                            <div id="hierarchy-tree"></div>
                        </div>
                        <div class="detail-panel">
                            <h3>Cluster Details</h3>
                            <div id="cluster-details"></div>
                        </div>
                    </div>
                </div>
                
                <div id="umap-tab" class="tab-content">
                    <div class="visualization-controls">
                        <button onclick="resetZoom()">Reset Zoom</button>
                        <button onclick="toggleLabels()">Toggle Labels</button>
                        <select id="color-by" onchange="updateColors()">
                            <option value="cluster">Color by Cluster</option>
                            <option value="facet">Color by Facet</option>
                            <option value="concern">Color by Concern Level</option>
                        </select>
                    </div>
                    <div id="umap-plot"></div>
                    <div id="selection-info"></div>
                </div>
                
                <div id="conversations-tab" class="tab-content">
                    <div class="conversation-browser">
                        <div class="filters">
                            <input type="text" id="search" placeholder="Search conversations...">
                            <select id="filter-facet">
                                <option value="">All Facets</option>
                            </select>
                            <select id="filter-cluster">
                                <option value="">All Clusters</option>
                            </select>
                        </div>
                        <div class="conversation-list" id="conversation-list"></div>
                        <div class="conversation-detail" id="conversation-detail"></div>
                    </div>
                </div>
                
                <div id="insights-tab" class="tab-content">
                    <div class="insights-dashboard">
                        <div class="stat-card">
                            <h4>Total Conversations</h4>
                            <div class="stat-value" id="total-conversations">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>Unique Clusters</h4>
                            <div class="stat-value" id="total-clusters">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>Languages Detected</h4>
                            <div class="stat-value" id="languages">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>Concern Distribution</h4>
                            <canvas id="concern-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="export-section">
                        <h3>Export Results</h3>
                        <button onclick="exportJSON()">Export as JSON</button>
                        <button onclick="exportCSV()">Export as CSV</button>
                        <button onclick="exportReport()">Generate Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Paste Data Modal -->
    <div id="paste-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePasteModal()">&times;</span>
            <h2>Paste Conversation Data</h2>
            <p>Paste your JSON formatted conversations below:</p>
            <textarea id="paste-area" placeholder='[
  [
    {"role": "user", "content": "Hello"},
    {"role": "assistant", "content": "Hi there!"}
  ]
]'></textarea>
            <button class="btn-primary" onclick="processPastedData()">Process Data</button>
        </div>
    </div>
    
    <script src="static/app.js"></script>
</body>
</html>